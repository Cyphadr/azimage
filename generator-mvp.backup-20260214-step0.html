<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A–Z 单词主题小说生成器</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro:ital,wght@0,400;0,700;1,400&family=Noto+Sans+SC:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cn-fontsource-source-han-sans-sc-vf@1.0.10/font.css" crossorigin="anonymous" />
  <link rel="preconnect" href="https://chinese-fonts-cdn.deno.dev" crossorigin />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="stylesheet" href="https://chinese-fonts-cdn.deno.dev/packages/cubic/dist/Cubic/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://chinese-fonts-cdn.deno.dev/packages/jpdzt/dist/BoutiqueBitmap9x9_1_6/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://chinese-fonts-cdn.deno.dev/packages/qxs/dist/quan/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@chinese-fonts/cubic@3.0.0/dist/Cubic/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@chinese-fonts/jpdzt@3.0.0/dist/BoutiqueBitmap9x9_1_6/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/eterfinal/ReiFonts/HuiwenFangsong/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cn-fontsource-fz-fang-song-z-02-s-regular@1.1.0/font.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cn-fontsource-lxgw-wen-kai-screen-r@1.0.6/font.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/eterfinal/ReiFonts/HuiwenMinchoGBK/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/eterfinal/ReiFonts/ChillRoundM/result.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="css-unified/az-theme-retro-fonts.css" />
  <link rel="stylesheet" href="css-unified/az-theme-pixel-fonts.css" />
  <link rel="stylesheet" href="css-unified/az-theme.css" />
  <link rel="stylesheet" href="css-unified/az-theme-retro-gui.css" />
  <link rel="stylesheet" href="css-unified/az-theme-vintage.css" />
  <link rel="stylesheet" href="css-unified/az-theme-poster.css" />
  <link rel="stylesheet" href="css-unified/az-theme-app.css" />
  <link rel="stylesheet" href="css-unified/az-theme-nippon.css" />
  <link rel="stylesheet" href="css-unified/az-theme-editorial.css" />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --text:#eaf2ff;
      --muted:#a9b6cc;
      --accent:#7aa8ff;

      --titleSize:28px;
      --bodySize:16px;
      --lineHeight:1.7;
      --radius:18px;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --bd: rgba(255,255,255,.08);

      --fontTitle: ui-serif, Georgia, "Times New Roman", serif;
      --fontBody: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--fontBody);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(122,168,255,.12), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(255,122,176,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1700px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: minmax(360px, 420px) minmax(250px, 320px) minmax(520px, 1fr);
      gap: 14px;
      align-items:start;
    }
    .layoutProject{min-width:0;}
    .layoutWords{min-width:0;}
    .layoutPreview{min-width:0;}
    @media (max-width: 1320px){
      .wrap{
        grid-template-columns: minmax(340px, 420px) minmax(240px, 1fr);
      }
      .layoutPreview{grid-column: 1 / -1;}
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr;}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--bd);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 14px;
      border-bottom:1px solid var(--bd);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background: rgba(0,0,0,.12);
    }
    .cardHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color: var(--text);
      opacity:.92;
    }
    .muted{color:var(--muted)}
    .cardBody{padding: 12px 14px;}
    .fold{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(0,0,0,.12);
      margin-top: 10px;
      overflow:hidden;
    }
    .fold summary{
      cursor:pointer;
      list-style:none;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid transparent;
    }
    .fold summary::-webkit-details-marker{display:none}
    .fold summary::after{
      content:"▾";
      font-size: 12px;
      color: var(--muted);
      transform: rotate(-90deg);
      transition: transform .16s ease;
    }
    .fold[open] summary{
      border-bottom-color: rgba(255,255,255,.08);
    }
    .fold[open] summary::after{
      transform: rotate(0deg);
    }
    .foldBody{
      padding: 10px 12px 12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], textarea, select{
      width:100%;
      background: rgba(0,0,0,.22);
      color: var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 10px 10px;
      outline:none;
    }
    textarea{min-height: 120px; resize: vertical; line-height:1.6}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color: rgba(122,168,255,.55);
      box-shadow: 0 0 0 3px rgba(122,168,255,.15);
    }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btnPrimary{
      background: linear-gradient(135deg, rgba(122,168,255,.35), rgba(255,122,176,.18));
      border-color: rgba(122,168,255,.35);
    }
    .btnDanger{border-color: rgba(255,140,140,.35)}
    .pill{
      font-size:12px;
      padding: 5px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color: var(--muted);
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    @media (max-width: 980px){
      .grid2,.grid3{grid-template-columns:1fr;}
    }
    .azList{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    @media (max-width: 980px){
      .azList{grid-template-columns: repeat(8, 1fr);}
    }
    .azBtn{
      padding: 10px 0;
      text-align:center;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.6px;
      color: rgba(234,242,255,.92);
      position:relative;
    }
    .azBtn:hover{background: rgba(255,255,255,.06)}
    .azBtn.active{
      background: linear-gradient(135deg, rgba(122,168,255,.28), rgba(0,0,0,.18));
      border-color: rgba(122,168,255,.45);
      box-shadow: 0 0 0 3px rgba(122,168,255,.14);
    }
    .lockDot{
      position:absolute;
      right: 7px;
      top: 7px;
      width:8px;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.22);
    }
    .azBtn.locked .lockDot{ background: rgba(255,122,176,.75); }
    .wordList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: calc(100vh - 130px);
      overflow:auto;
      padding-right: 2px;
    }
    .wordRow{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      background: rgba(0,0,0,.16);
      padding: 8px 9px;
      cursor:pointer;
      transition: border-color .14s ease, background .14s ease;
    }
    .wordRow:hover{
      border-color: rgba(122,168,255,.45);
      background: rgba(122,168,255,.10);
    }
    .wordRow.active{
      border-color: rgba(122,168,255,.58);
      box-shadow: 0 0 0 2px rgba(122,168,255,.18) inset;
    }
    .wordRowTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:8px;
    }
    .wordRowLetter{
      font-weight:700;
      color: var(--accent);
      letter-spacing:.4px;
      min-width: 20px;
    }
    .wordRowEn{
      flex:1;
      font-size: 13px;
      color: var(--text);
      word-break: break-word;
    }
    .wordRowZh{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      word-break: break-word;
    }
    .wordRowEmpty{
      font-size:12px;
      color: var(--muted);
      padding: 8px 2px;
    }
    #themeVarsPanel{
      display: none;
      flex: 1 1 auto !important;
      min-width: 0 !important;
    }
    #themeVarsMount #themeVarsPanel{
      display:block;
    }
    #themeVarsPanel > .card{
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    #themeVarsPanel > .card > .cardHeader{
      display:none !important;
    }
    #themeVarsPanel > .card > .cardBody{
      padding: 0 !important;
    }

    .help{
      font-size:12px;
      color: var(--muted);
      line-height:1.55;
    }

    .previewWrap{
      padding: 10px;
    }
    .previewStage{
      min-width: 0;
      min-height: 0;
    }
    .previewSticky{
      position: sticky;
      top: 12px;
      max-height: calc(100vh - 24px);
      overflow:auto;
    }
    .previewStage.az-page{
      min-height: 0;
      padding: 10px;
      border-radius: calc(var(--radius) + 4px);
      background: transparent !important;
      background-image: none !important;
    }
    .dualPreview{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }
    .dualItem{
      min-width: 0;
    }
    .dualLabel{
      font-size:12px;
      color: var(--muted);
      margin: 0 0 8px;
      padding-left: 2px;
    }
    .dualPreview .az-export-frame{
      max-width: none;
    }
    .dualPreview .az-letter-page__body{
      white-space: pre-wrap;
    }
    .dualPreview .az-body-page-meta__title,
    .dualPreview .az-body-page-meta__author,
    .dualPreview .az-body-page-watermark__input{
      pointer-events:auto;
      background: transparent !important;
      border: none !important;
      border-bottom: none !important;
      box-shadow: none !important;
      outline: none !important;
      padding: 0 !important;
      min-width: 0 !important;
      width: auto !important;
      caret-color: currentColor;
      cursor: text;
    }
    @media (max-width: 1050px){
      .dualPreview{
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 1320px){
      .previewSticky{
        position: static;
        max-height: none;
        overflow: visible;
      }
    }

    .control{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .control.uploadControl{
      grid-template-columns: 1fr;
      align-items:stretch;
      gap: 6px;
    }
    .control.uploadControl input[type="file"]{
      width: 100%;
      font-size: 12px;
      color: var(--muted);
    }
    .panelGroupTitle{
      font-size: 12px;
      color: var(--text);
      opacity: .92;
      letter-spacing: .2px;
      margin: 0 0 6px;
    }
    .compact2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .compact2 .control{
      grid-template-columns: 1fr;
      align-items:stretch;
    }
    .compact2 .control input[type="range"]{
      width: 100%;
      max-width: none;
    }
    .compact2 .control input[type="color"]{
      justify-self: start;
    }
    .compact2 .control.controlFull{
      grid-column: 1 / -1;
    }
    @media (max-width: 980px){
      .compact2{grid-template-columns: 1fr;}
    }
    .control input[type="range"]{
      width: 220px;
      max-width: 52vw;
      accent-color: var(--accent, #2f76ff);
    }
    .control input[type="color"]{
      width: 40px; height: 30px;
      padding:0; border:0;
      background: transparent;
      cursor:pointer;
    }
    .compact2 .control input[type="range"]{
      width: 100% !important;
      max-width: none !important;
    }
    .small{font-size:12px; color: var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
      display:none;
    }
    .toast.show{display:block;}

    /* Fine-grained preview bindings */
    #previewScope .az-cover__title{
      color: var(--custom-cover-title-color, var(--color-cover-title)) !important;
      font-size: var(--custom-cover-title-size, var(--font-size-title)) !important;
    }
    #previewScope .az-cover__badge{
      color: var(--custom-cover-badge-color, var(--color-cover-badge)) !important;
      font-size: var(--custom-cover-badge-size, var(--font-size-small)) !important;
    }
    #previewScope .az-cover__author{
      color: var(--custom-cover-author-color, var(--color-cover-author)) !important;
      font-size: var(--custom-cover-author-size, var(--font-size-body)) !important;
    }
    #previewScope .az-cover__image-preview{
      opacity: var(--custom-cover-image-opacity, 1);
    }
    #previewScope .az-body-page-meta__title,
    #previewScope .az-body-page-meta__author,
    #previewScope .az-body-page-watermark__input{
      color: var(--custom-meta-color, var(--color-text-secondary)) !important;
      font-size: var(--custom-meta-size, var(--font-size-small)) !important;
    }
    #previewScope .az-letter-page__card{
      background: var(--custom-card-box-bg, var(--color-surface)) !important;
      border-color: var(--custom-deco-color, var(--color-border)) !important;
    }
    #previewScope .az-letter-page__card::after{
      background: var(--custom-deco-color, var(--gradient-accent)) !important;
    }
    #previewScope .az-cover::after,
    #previewScope .az-cover .az-cover__deco{
      border-color: var(--custom-deco-color, var(--color-border)) !important;
    }
    #previewScope .az-letter-page__letter{
      color: var(--custom-letter-color, var(--color-accent)) !important;
      font-size: var(--custom-letter-size, var(--font-size-letter-badge)) !important;
      background: none !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      -webkit-text-fill-color: var(--custom-letter-color, var(--color-accent));
    }
    #previewScope .az-letter-page__word{
      color: var(--custom-word-color, var(--color-primary)) !important;
      font-size: var(--custom-word-size, var(--font-size-subtitle)) !important;
    }
    #previewScope .az-letter-page__translation{
      color: var(--custom-trans-color, var(--color-text-secondary)) !important;
      font-size: var(--custom-trans-size, var(--font-size-body)) !important;
    }
    #previewScope .az-letter-page__body{
      color: var(--custom-body-color, var(--color-text)) !important;
      font-size: var(--custom-body-size, var(--font-size-body)) !important;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LEFT -->
    <section class="card layoutProject">
      <div class="cardHeader">
        <h2>项目与生成</h2>
        <span class="pill" id="progressPill">完成度 0/26</span>
      </div>
      <div class="cardBody">

        <div class="grid2">
          <div>
            <label>项目标题（可选）</label>
            <input id="projectTitle" type="text" placeholder="例如：A–Z 主题短篇集 / 霓虹雨夜 / 温柔日常" />
          </div>
          <div>
            <label>作者（可选）</label>
            <input id="projectAuthor" type="text" placeholder="作者名" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid2">
          <div>
            <label>副标题（封面小字）</label>
            <input id="projectSubtitle" type="text" placeholder="可填副标题 / OC 姓名 / CP 等" />
            <div class="small" style="margin-top:6px">用于封面左上小字，并自动同步到卡片右上第一行。</div>
          </div>
          <div>
            <label>水印</label>
            <input id="projectWatermark" type="text" placeholder="可自由填写" />
            <div class="small" style="margin-top:6px">显示在卡片下方居中位置，可自由填写。</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid3">
          <div>
            <label>风格主题</label>
            <select id="styleSelect">
              <option value="gothic">哥特 / 暗色文学</option>
              <option value="cyber">赛博 / 霓虹科幻</option>
              <option value="cozy">温柔日常 / 手账感</option>
            </select>
          </div>
          <div>
            <label>主题皮肤</label>
            <select id="themeSelect">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="pixel">Pixel</option>
              <option value="chinese-retro">Chinese Retro</option>
              <option value="retro-gui">Retro GUI</option>
              <option value="vintage">Vintage</option>
              <option value="poster">Poster</option>
              <option value="app">App</option>
              <option value="nippon">Nippon</option>
              <option value="editorial">Editorial</option>
            </select>
          </div>
          <div>
            <label>导出尺寸预设</label>
            <select id="sizePreset">
              <option value="1080x1920">手机竖图 1080×1920</option>
              <option value="1440x2560">手机竖图 1440×2560</option>
              <option value="1080x1080">方图 1080×1080</option>
              <option value="2048x2048">方图 2048×2048</option>
              <option value="1920x1080">横图 1920×1080</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button class="btn btnPrimary" id="genBtn">随机生成 A–Z（未锁定项）</button>
          <button class="btn" id="fillDemoBtn">填入示例段落（未写项）</button>
          <button class="btn btnDanger" id="clearAllBtn">清空全部段落</button>
        </div>
        <div style="height:8px"></div>
        <div class="row" id="projectSaveLoadMount">
          <button class="btn" id="saveLocalBtn">保存本地</button>
          <button class="btn" id="loadLocalBtn">导入进度</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div class="small">选择字母进入编辑。右上小点表示“锁定”。</div>
          <div class="row">
            <button class="btn" id="lockAllBtn">全锁定</button>
            <button class="btn" id="unlockAllBtn">全解锁</button>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="azList" id="azList"></div>

        <details class="fold" open>
          <summary>基础编辑区</summary>
          <div class="foldBody">
            <div class="grid2">
              <div>
                <label>当前字母：<span id="curLetter" class="muted">A</span></label>
                <div class="row" style="justify-content:space-between; margin-top:6px">
                  <button class="btn" id="toggleLockBtn">切换锁定</button>
                  <span class="pill" id="lockPill">未锁定</span>
                </div>
              </div>
              <div>
                <label>快捷操作</label>
                <div class="row" style="margin-top:6px">
                  <button class="btn" id="prevBtn">← 上一个</button>
                  <button class="btn" id="nextBtn">下一个 →</button>
                </div>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="grid2">
              <div>
                <label>英文单词</label>
                <input id="wordEn" type="text" placeholder="例如：Abyss" />
              </div>
              <div>
                <label>中文翻译</label>
                <input id="wordZh" type="text" placeholder="例如：深渊" />
              </div>
            </div>

            <div style="height:10px"></div>

            <div>
              <label>该单词对应的文段（纯文本）</label>
              <textarea id="entryText" placeholder="围绕该单词写一段（会出现在导出的卡片上）"></textarea>
              <div class="row" style="justify-content:space-between; margin-top:8px">
                <span class="small" id="countInfo">字数：0</span>
                <span class="small">导出：封面 / 当前字母 / 封面+26字母 ZIP / 正文长图。</span>
              </div>
            </div>
          </div>
        </details>

        <details class="fold" open>
          <summary>主题变量区</summary>
          <div class="foldBody" id="themeVarsMount"></div>
        </details>

      </div>
    </section>

    <section class="card layoutWords">
      <div class="cardHeader">
        <h2>单词列表</h2>
        <span class="pill">当前词表</span>
      </div>
      <div class="cardBody">
        <div class="small" style="margin-bottom:8px">点击任意字母可快速切换到该条目编辑。</div>
        <div class="wordList" id="wordList"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card layoutPreview previewSticky">
      <div class="cardHeader">
        <h2>预览与导出</h2>
        <div class="row">
          <button class="btn" id="exportCoverBtn">导出封面</button>
          <button class="btn" id="exportOneBtn">导出当前字母</button>
          <button class="btn btnPrimary" id="exportZipBtn">导出封面+26字母 ZIP</button>
          <button class="btn" id="exportLongBtn">导出正文长图</button>
        </div>
      </div>

        <div class="previewWrap">
          <div class="previewStage az-page" id="previewScope" data-theme="light">
            <div class="dualPreview">
              <div class="dualItem">
                <div class="dualLabel">标题页预览</div>
                <div class="az-export-frame az-export-frame--cover az-cover" id="coverFrame">
                  <div class="az-cover__image" aria-label="头图">
                    <img class="az-cover__image-preview" id="coverImagePreview" src="" alt="" hidden />
                  </div>
                  <div class="az-cover__inner">
                    <p class="az-cover__badge" id="pvBadge">A–Z 短篇合集</p>
                    <h1 class="az-cover__title" id="pvTitle">A–Z 主题短篇集</h1>
                    <p class="az-cover__subtitle" id="pvCoverSubtitle"></p>
                    <p class="az-cover__author" id="pvAuthor">作者：—</p>
                  </div>
                  <div class="az-cover__deco" aria-hidden="true"></div>
                </div>
              </div>

              <div class="dualItem">
                <div class="dualLabel">当前字母卡片预览</div>
                <div class="az-export-frame az-export-frame--letter az-letter-page" id="letterFrame">
                  <div class="az-body-page-meta" aria-label="正文页标题与作者">
                    <input type="text" class="az-body-page-meta__title" id="pvMetaTitle" placeholder="副标题" readonly />
                    <input type="text" class="az-body-page-meta__author" id="pvMetaAuthor" placeholder="作者" readonly />
                  </div>
                  <div class="az-letter-page__card-wrap" id="pvCardWrap" data-letter="A">
                    <div class="az-letter-page__card">
                      <header class="az-letter-page__header">
                        <span class="az-letter-page__letter" id="pvLetter">A</span>
                        <span class="az-letter-page__word" id="pvWord">Abyss</span>
                        <span class="az-letter-page__translation" id="pvTrans">深渊</span>
                      </header>
                      <p class="az-letter-page__body" id="pvPara">（在左侧输入你的段落）</p>
                    </div>
                  </div>
                  <div class="az-body-page-watermark" aria-label="水印">
                    <input type="text" class="az-body-page-watermark__input" id="pvWatermark" placeholder="水印" readonly />
                  </div>
                </div>
              </div>
            </div>
            <div class="toast" id="toast"></div>
          </div>

        <div id="themeVarsPanel" style="flex: 0 0 340px; min-width: 300px">
          <div class="card" style="background: rgba(0,0,0,.10); border-radius: var(--radius); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
            <div class="cardHeader" style="background: rgba(0,0,0,.12);">
              <h2>样式变量面板</h2>
              <span class="pill">仅作用导出预览与导出图</span>
            </div>
            <div class="cardBody">

              <div class="panelGroupTitle">背景与基础排版</div>
              <div class="compact2">
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">封面背景色</div>
                  </div>
                  <input type="color" id="coverBgColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">卡片页背景色</div>
                  </div>
                  <input type="color" id="letterBgColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">中文翻译颜色</div>
                  </div>
                  <input type="color" id="transColorFine" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">中文翻译字号</div>
                    <div style="font-size:12px;opacity:.9" id="bodySizeLabel">16px</div>
                  </div>
                  <input type="range" id="bodySize" min="12" max="24" value="16" />
                </div>
              </div>

              <div style="height:8px"></div>

              <div class="control">
                <div>
                  <div style="font-size:12px;color:var(--muted)">圆角</div>
                  <div style="font-size:12px;opacity:.9" id="radiusLabel">18px</div>
                </div>
                <input type="range" id="radius" min="10" max="34" value="18" />
              </div>

              <div style="height:12px"></div>
              <div class="panelGroupTitle">封面精细控制</div>

              <div class="compact2">
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">标题颜色</div>
                  </div>
                  <input type="color" id="coverTitleColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">标题字号</div>
                    <div style="font-size:12px;opacity:.9" id="coverTitleSizeLabel">42px</div>
                  </div>
                  <input type="range" id="coverTitleSize" min="18" max="80" value="42" />
                </div>

                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">副标题颜色</div>
                  </div>
                  <input type="color" id="coverBadgeColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">副标题字号</div>
                    <div style="font-size:12px;opacity:.9" id="coverBadgeSizeLabel">14px</div>
                  </div>
                  <input type="range" id="coverBadgeSize" min="10" max="34" value="14" />
                </div>

                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">作者颜色</div>
                  </div>
                  <input type="color" id="coverAuthorColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">作者字号</div>
                    <div style="font-size:12px;opacity:.9" id="coverAuthorSizeLabel">16px</div>
                  </div>
                  <input type="range" id="coverAuthorSize" min="10" max="34" value="16" />
                </div>
              </div>

              <div style="height:8px"></div>
              <div class="control">
                <div>
                  <div style="font-size:12px;color:var(--muted)">头图透明度</div>
                  <div style="font-size:12px;opacity:.9" id="coverImageOpacityLabel">100%</div>
                </div>
                <input type="range" id="coverImageOpacity" min="0" max="100" value="100" />
              </div>

              <div style="height:12px"></div>
              <div class="panelGroupTitle">卡片精细控制</div>
              <div class="compact2">
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">右上小字/水印颜色</div>
                  </div>
                  <input type="color" id="metaColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">右上小字/水印字号</div>
                    <div style="font-size:12px;opacity:.9" id="metaSizeLabel">13px</div>
                  </div>
                  <input type="range" id="metaSize" min="10" max="30" value="13" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">文本框底色</div>
                  </div>
                  <input type="color" id="cardBoxColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">文本框透明度</div>
                    <div style="font-size:12px;opacity:.9" id="cardBoxOpacityLabel">100%</div>
                  </div>
                  <input type="range" id="cardBoxOpacity" min="0" max="100" value="100" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">字母颜色</div>
                  </div>
                  <input type="color" id="letterColor" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">字母字号</div>
                    <div style="font-size:12px;opacity:.9" id="letterSizeLabel">44px</div>
                  </div>
                  <input type="range" id="letterSize" min="20" max="130" value="44" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">单词颜色</div>
                  </div>
                  <input type="color" id="wordColorFine" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">单词字号</div>
                    <div style="font-size:12px;opacity:.9" id="wordSizeFineLabel">22px</div>
                  </div>
                  <input type="range" id="wordSizeFine" min="12" max="56" value="22" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">正文颜色</div>
                  </div>
                  <input type="color" id="bodyColorFine" />
                </div>
                <div class="control">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">正文字号</div>
                    <div style="font-size:12px;opacity:.9" id="bodySizeFineLabel">16px</div>
                  </div>
                  <input type="range" id="bodySizeFine" min="12" max="36" value="16" />
                </div>
                <div class="control controlFull">
                  <div>
                    <div style="font-size:12px;color:var(--muted)">装饰/边框颜色</div>
                  </div>
                  <input type="color" id="decoColor" />
                </div>
              </div>

              <div style="height:12px"></div>
              <div class="panelGroupTitle">背景与头图上传</div>

              <div class="control uploadControl">
                <div>
                  <div style="font-size:12px;color:var(--muted)">封面背景图</div>
                  <div style="font-size:12px;opacity:.9">仅作用于标题页导出帧</div>
                </div>
                <input id="coverBgImageInput" type="file" accept="image/*" />
              </div>

              <div style="height:8px"></div>

              <div class="control uploadControl">
                <div>
                  <div style="font-size:12px;color:var(--muted)">卡片页背景图</div>
                  <div style="font-size:12px;opacity:.9">仅作用于字母卡片页导出帧</div>
                </div>
                <input id="letterBgImageInput" type="file" accept="image/*" />
              </div>

              <div style="height:8px"></div>

              <div class="row" style="justify-content:space-between">
                <label style="display:flex;align-items:center;gap:6px">
                  <input id="coverBgImageEnabled" type="checkbox" checked />
                  启用封面背景图
                </label>
                <button class="btn" id="clearCoverBgImageBtn" type="button">清除封面背景图</button>
              </div>

              <div style="height:8px"></div>

              <div class="row" style="justify-content:space-between">
                <label style="display:flex;align-items:center;gap:6px">
                  <input id="letterBgImageEnabled" type="checkbox" checked />
                  启用卡片页背景图
                </label>
                <button class="btn" id="clearLetterBgImageBtn" type="button">清除卡片页背景图</button>
              </div>

              <div style="height:8px"></div>

              <div class="control uploadControl">
                <div>
                  <div style="font-size:12px;color:var(--muted)">封面头图</div>
                  <div style="font-size:12px;opacity:.9">保留装饰容器，独立于背景图</div>
                </div>
                <input id="coverImageInput" type="file" accept="image/*" />
              </div>

              <div style="height:8px"></div>

              <div class="row" style="justify-content:space-between">
                <label style="display:flex;align-items:center;gap:6px">
                  <input id="coverImageEnabled" type="checkbox" checked />
                  启用封面头图
                </label>
                <button class="btn" id="clearCoverImageBtn" type="button">清除头图</button>
              </div>

              <div style="height:12px"></div>

              <div class="row">
                <button class="btn" id="resetVarsBtn">重置变量（按主题默认）</button>
              </div>

              <div class="help" style="margin-top:10px">
                导出基于右侧预览 DOM，封面与字母卡片会与预览视觉一致。<br>
                支持：封面 PNG、当前字母 PNG、封面+26字母 ZIP、正文长图 PNG。
              </div>

            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
  <div id="themeProbe" class="az-page" data-theme="light" style="position:fixed;left:-99999px;top:-99999px;width:1px;height:1px;overflow:hidden;pointer-events:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
  const letters = Array.from({length:26}, (_,i)=>String.fromCharCode(65+i));

  const THEME_IDS = ["light","dark","pixel","chinese-retro","retro-gui","vintage","poster","app","nippon","editorial"];
  const FALLBACK_VARS = {
    "--bg":"#0b0f14",
    "--card":"#111824",
    "--text":"#eaf2ff",
    "--muted":"#a9b6cc",
    "--accent":"#7aa8ff",
    "--titleSize":"28px",
    "--bodySize":"16px",
    "--radius":"18px",
    "--lineHeight":"1.7",
    "--fontTitle":"ui-serif, Georgia, 'Times New Roman', serif",
    "--fontBody":"system-ui, -apple-system, Segoe UI, Roboto, Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif",
    "--bd":"rgba(255,255,255,.08)",
    "--shadow":"0 10px 30px rgba(0,0,0,.35)"
  };

  const GENERIC = {
    A:[["Abyss","深渊"],["Aurora","极光"],["Altar","祭坛"]],
    B:[["Breathe","呼吸"],["Bloom","绽放"],["Bargain","交易"]],
    C:[["Cinder","余烬"],["Cipher","密文"],["Cradle","摇篮"]],
    D:[["Dawn","黎明"],["Dread","惧意"],["Drift","漂流"]],
    E:[["Echo","回声"],["Ember","余火"],["Eclipse","食"]],
    F:[["Fable","寓言"],["Fracture","裂隙"],["Frost","霜"]],
    G:[["Gloom","阴翳"],["Glitch","故障"],["Garden","花园"]],
    H:[["Hollow","空洞"],["Haven","避风港"],["Hush","寂声"]],
    I:[["Ivory","象牙白"],["Impulse","冲动"],["Ink","墨"]],
    J:[["Jade","玉"],["Jolt","震颤"],["Jubilee","庆典"]],
    K:[["Knot","结"],["Karma","业"],["Kernel","核"]],
    L:[["Lullaby","摇篮曲"],["Labyrinth","迷宫"],["Lumen","流明"]],
    M:[["Murmur","呢喃"],["Mirage","海市蜃楼"],["Mercy","怜悯"]],
    N:[["Nocturne","夜曲"],["Nexus","枢纽"],["Nest","巢"]],
    O:[["Oath","誓言"],["Orbit","轨道"],["Omen","征兆"]],
    P:[["Pulse","脉搏"],["Paradox","悖论"],["Petal","花瓣"]],
    Q:[["Quiver","颤动"],["Quarry","猎物"],["Quill","羽笔"]],
    R:[["Ruin","废墟"],["Rapture","狂喜"],["Ribbon","缎带"]],
    S:[["Silhouette","剪影"],["Static","静电"],["Solace","慰藉"]],
    T:[["Threshold","门槛"],["Tremor","震颤"],["Tea","茶"]],
    U:[["Undertow","暗涌"],["Umbra","本影"],["Utopia","乌托邦"]],
    V:[["Veil","面纱"],["Vector","向量"],["Velvet","天鹅绒"]],
    W:[["Wander","漫游"],["Wound","伤口"],["Whisper","耳语"]],
    X:[["Xenon","氙"],["Xylophone","木琴"],["Xylem","木质部"]],
    Y:[["Yearning","渴望"],["Yonder","远方"],["Yield","让步"]],
    Z:[["Zenith","天顶"],["Zephyr","和风"],["Zero","零"]],
  };

  const STYLE_OVERRIDES = {
    gothic: {
      A:[["Abyss","深渊"],["Ashen","灰烬色"],["Atonement","赎罪"]],
      B:[["Banshee","女妖"],["Burial","葬礼"],["Bleak","萧瑟"]],
      C:[["Crypt","地穴"],["Coffin","棺"],["Cinder","余烬"]],
      D:[["Dirge","挽歌"],["Dusk","暮色"],["Dread","惧意"]],
      E:[["Elegy","挽诗"],["Eclipse","食"],["Ember","余火"]],
      F:[["Forsaken","遗弃"],["Frost","霜"],["Fable","寓言"]],
      G:[["Grave","墓"],["Gloom","阴翳"],["Gothic","哥特"]],
      H:[["Hollow","空洞"],["Heresy","异端"],["Hush","寂声"]],
      I:[["Incantation","咒文"],["Ichor","神血"],["Ink","墨"]],
      J:[["Judgement","审判"],["Jinx","厄运"],["Jade","玉"]],
      K:[["Kneel","跪"],["Knot","结"],["Karma","业"]],
      L:[["Lament","哀歌"],["Labyrinth","迷宫"],["Lullaby","摇篮曲"]],
      M:[["Mourning","哀悼"],["Miasma","瘴气"],["Murmur","呢喃"]],
      N:[["Nocturne","夜曲"],["Necropolis","亡城"],["Numb","麻木"]],
      O:[["Omen","征兆"],["Oath","誓言"],["Oblivion","遗忘"]],
      P:[["Phantom","幽影"],["Penance","苦修"],["Pulse","脉搏"]],
      Q:[["Quill","羽笔"],["Quietus","寂灭"],["Quiver","颤动"]],
      R:[["Ruin","废墟"],["Requiem","安魂曲"],["Raven","渡鸦"]],
      S:[["Sepulcher","坟冢"],["Silhouette","剪影"],["Sable","乌黑"]],
      T:[["Tomb","墓"],["Threshold","门槛"],["Tremor","震颤"]],
      U:[["Umbra","本影"],["Undertow","暗涌"],["Unholy","不洁"]],
      V:[["Veil","面纱"],["Vesper","晚祷"],["Venom","毒"]],
      W:[["Wound","伤口"],["Whisper","耳语"],["Witch","女巫"]],
      X:[["Xylem","木质部"],["Xenon","氙"],["Xiphoid","剑突"]],
      Y:[["Yearning","渴望"],["Yew","紫杉"],["Yield","让步"]],
      Z:[["Zephyr","和风"],["Zenith","天顶"],["Zero","零"]],
    },
    cyber: {
      A:[["Algorithm","算法"],["Augment","增强"],["Avatar","化身"]],
      B:[["Bandwidth","带宽"],["Backdoor","后门"],["Binary","二进制"]],
      C:[["Cipher","密文"],["Circuit","电路"],["Core","内核"]],
      D:[["Datastream","数据流"],["Drone","无人机"],["Debug","调试"]],
      E:[["Encryption","加密"],["Echo","回声"],["Endpoint","端点"]],
      F:[["Firewall","防火墙"],["Firmware","固件"],["Fragment","碎片"]],
      G:[["Glitch","故障"],["Grid","网格"],["Ghost","幽灵进程"]],
      H:[["Hologram","全息"],["Handshake","握手协议"],["Hub","枢纽"]],
      I:[["Interface","接口"],["Implant","植入体"],["Index","索引"]],
      J:[["Jitter","抖动"],["Junction","接点"],["Joystick","摇杆"]],
      K:[["Kernel","内核"],["Keypair","密钥对"],["Kiosk","终端机"]],
      L:[["Latency","延迟"],["Loop","循环"],["Lumen","流明"]],
      M:[["Mainframe","主机"],["Mesh","网状"],["Mirage","幻象"]],
      N:[["Nexus","中枢"],["Neon","霓虹"],["Node","节点"]],
      O:[["Override","覆写"],["Orbit","轨道"],["Opcode","操作码"]],
      P:[["Protocol","协议"],["Pulse","脉冲"],["Proxy","代理"]],
      Q:[["Quantum","量子"],["Query","查询"],["Queue","队列"]],
      R:[["Router","路由"],["Runtime","运行时"],["Rift","裂隙"]],
      S:[["Subnet","子网"],["Signal","信号"],["Static","静电"]],
      T:[["Terminal","终端"],["Token","令牌"],["Tether","系链"]],
      U:[["Upload","上传"],["Uplink","上行"],["Userland","用户态"]],
      V:[["Vector","向量"],["Virtual","虚拟"],["Voltage","电压"]],
      W:[["Wavelength","波长"],["Worm","蠕虫"],["Workspace","工作区"]],
      X:[["Xenon","氙"],["XOR","异或"],["XSS","跨站脚本"]],
      Y:[["Yield","让步"],["Yottabyte","尧字节"],["Y-axis","Y轴"]],
      Z:[["Zero-day","零日漏洞"],["Zone","区域"],["Zenith","天顶"]],
    },
    cozy: {
      A:[["Afternoon","午后"],["Apricot","杏子"],["Almond","杏仁"]],
      B:[["Blanket","毛毯"],["Bakery","面包店"],["Breeze","微风"]],
      C:[["Cocoa","可可"],["Candle","蜡烛"],["Cottage","小屋"]],
      D:[["Daisy","雏菊"],["Daydream","白日梦"],["Dawn","黎明"]],
      E:[["Embrace","拥抱"],["Earlgrey","伯爵茶"],["Echo","回声"]],
      F:[["Fireplace","壁炉"],["Fika","咖啡小憩"],["Flourish","绽放"]],
      G:[["Garden","花园"],["Giggle","咯咯笑"],["Glow","微光"]],
      H:[["Honey","蜂蜜"],["Haven","避风港"],["Hearth","炉边"]],
      I:[["Ink","墨"],["Ivory","象牙白"],["Idle","悠闲"]],
      J:[["Jam","果酱"],["Jasmine","茉莉"],["Joy","喜悦"]],
      K:[["Kettle","水壶"],["Kindness","善意"],["Knit","编织"]],
      L:[["Lullaby","摇篮曲"],["Lantern","灯笼"],["Lavender","薰衣草"]],
      M:[["Mug","马克杯"],["Meadow","草地"],["Murmur","呢喃"]],
      N:[["Nest","巢"],["Notebook","笔记本"],["Nuzzle","依偎"]],
      O:[["Oatmilk","燕麦奶"],["Origami","折纸"],["Oasis","绿洲"]],
      P:[["Petal","花瓣"],["Porch","门廊"],["Pillow","枕头"]],
      Q:[["Quilt","拼布被"],["Quiet","安静"],["Quill","羽笔"]],
      R:[["Recipe","食谱"],["Ribbon","缎带"],["Rainlight","雨光"]],
      S:[["Solace","慰藉"],["Sunbeam","日光束"],["Spoon","勺"]],
      T:[["Tea","茶"],["Tender","温柔"],["Thimble","顶针"]],
      U:[["Umbrella","伞"],["Utopia","乌托邦"],["Upbeat","轻快"]],
      V:[["Velvet","天鹅绒"],["Vase","花瓶"],["Vanilla","香草"]],
      W:[["Warmth","暖意"],["Wander","漫游"],["Whisper","耳语"]],
      X:[["Xylophone","木琴"],["Xylem","木质部"],["Xenon","氙"]],
      Y:[["Yearning","渴望"],["Yonder","远方"],["Yummy","好吃"]],
      Z:[["Zephyr","和风"],["Zest","清新"],["Zen","禅意"]],
    }
  };

  const state = {
    projectTitle: "A–Z 主题短篇集",
    projectAuthor: "",
    projectSubtitle: "A–Z 短篇合集",
    projectWatermark: "{letter} / Z",
    style: "gothic",
    theme: "light",
    vars: {...FALLBACK_VARS},
    coverBgImageData: "",
    coverBgImageRuntimeUrl: "",
    coverBgImageObjectUrl: "",
    coverBgImageEl: null,
    coverBgImageEnabled: true,
    letterBgImageData: "",
    letterBgImageRuntimeUrl: "",
    letterBgImageObjectUrl: "",
    letterBgImageEl: null,
    letterBgImageEnabled: true,
    coverImageData: "",
    coverImageEnabled: true,
    items: {},
    current: "A"
  };

  function initItems(){
    letters.forEach(L=>{
      state.items[L] = state.items[L] || { en:"", zh:"", text:"", locked:false };
    });
  }

  const $ = (id)=>document.getElementById(id);

  const azList = $("azList");
  const wordList = $("wordList");
  const curLetter = $("curLetter");
  const lockPill = $("lockPill");
  const themeVarsMount = $("themeVarsMount");
  const themeVarsPanel = $("themeVarsPanel");

  const wordEn = $("wordEn");
  const wordZh = $("wordZh");
  const entryText = $("entryText");

  const pvLetter = $("pvLetter");
  const pvWord = $("pvWord");
  const pvTrans = $("pvTrans");
  const pvPara = $("pvPara");
  const pvBadge = $("pvBadge");
  const pvTitle = $("pvTitle");
  const pvCoverSubtitle = $("pvCoverSubtitle");
  const pvAuthor = $("pvAuthor");
  const pvMetaTitle = $("pvMetaTitle");
  const pvMetaAuthor = $("pvMetaAuthor");
  const pvCardWrap = $("pvCardWrap");
  const pvWatermark = $("pvWatermark");
  const coverFrame = $("coverFrame");
  const coverImagePreview = $("coverImagePreview");
  const letterFrame = $("letterFrame");
  const previewScope = $("previewScope");
  const themeProbe = $("themeProbe");

  const progressPill = $("progressPill");
  const toast = $("toast");

  const coverBgColor = $("coverBgColor");
  const letterBgColor = $("letterBgColor");
  const transColorFine = $("transColorFine");
  const bodySize = $("bodySize");
  const radius = $("radius");
  const bodySizeLabel = $("bodySizeLabel");
  const radiusLabel = $("radiusLabel");
  const coverBgImageInput = $("coverBgImageInput");
  const coverBgImageEnabled = $("coverBgImageEnabled");
  const clearCoverBgImageBtn = $("clearCoverBgImageBtn");
  const letterBgImageInput = $("letterBgImageInput");
  const letterBgImageEnabled = $("letterBgImageEnabled");
  const clearLetterBgImageBtn = $("clearLetterBgImageBtn");
  const coverImageInput = $("coverImageInput");
  const coverImageEnabled = $("coverImageEnabled");
  const clearCoverImageBtn = $("clearCoverImageBtn");
  const projectSubtitleInput = $("projectSubtitle");
  const projectWatermarkInput = $("projectWatermark");
  const coverTitleColor = $("coverTitleColor");
  const coverTitleSize = $("coverTitleSize");
  const coverTitleSizeLabel = $("coverTitleSizeLabel");
  const coverBadgeColor = $("coverBadgeColor");
  const coverBadgeSize = $("coverBadgeSize");
  const coverBadgeSizeLabel = $("coverBadgeSizeLabel");
  const coverAuthorColor = $("coverAuthorColor");
  const coverAuthorSize = $("coverAuthorSize");
  const coverAuthorSizeLabel = $("coverAuthorSizeLabel");
  const coverImageOpacity = $("coverImageOpacity");
  const coverImageOpacityLabel = $("coverImageOpacityLabel");
  const metaColor = $("metaColor");
  const metaSize = $("metaSize");
  const metaSizeLabel = $("metaSizeLabel");
  const cardBoxColor = $("cardBoxColor");
  const cardBoxOpacity = $("cardBoxOpacity");
  const cardBoxOpacityLabel = $("cardBoxOpacityLabel");
  const decoColor = $("decoColor");
  const letterColor = $("letterColor");
  const letterSize = $("letterSize");
  const letterSizeLabel = $("letterSizeLabel");
  const wordColorFine = $("wordColorFine");
  const wordSizeFine = $("wordSizeFine");
  const wordSizeFineLabel = $("wordSizeFineLabel");
  const bodyColorFine = $("bodyColorFine");
  const bodySizeFine = $("bodySizeFine");
  const bodySizeFineLabel = $("bodySizeFineLabel");

  function mountThemeVarsPanel(){
    if(!themeVarsMount || !themeVarsPanel) return;
    if(themeVarsPanel.parentElement !== themeVarsMount){
      themeVarsMount.appendChild(themeVarsPanel);
    }
    themeVarsPanel.style.flex = "1 1 auto";
    themeVarsPanel.style.minWidth = "0";
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 2800);
  }

  function setCSSVars(vars){
    const target = previewScope || document.documentElement;
    Object.entries(vars).forEach(([k,v])=> target.style.setProperty(k, v));
    const map = {
      "--bg":"--color-background",
      "--card":"--color-surface",
      "--text":"--color-text",
      "--muted":"--color-text-secondary",
      "--accent":"--color-accent",
      "--radius":"--radius-card",
      "--fontBody":"--font-family"
    };
    Object.entries(map).forEach(([from, to])=>{
      if(vars[from]) target.style.setProperty(to, vars[from]);
    });
    if(vars["--lineHeight"]){
      target.style.setProperty("--line-height-body", vars["--lineHeight"]);
    }
    applyPreviewBackground();
  }

  function hexToRgb(hex){
    const h = hex.replace("#","").trim();
    if(h.length !== 6) return {r:255,g:255,b:255};
    return {r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16)};
  }

  function rgba(color, a){
    if(color.startsWith("#")){
      const {r,g,b} = hexToRgb(color);
      return `rgba(${r},${g},${b},${a})`;
    }
    if(color.startsWith("rgb(")){
      return color.replace("rgb(", "rgba(").replace(")", `,${a})`);
    }
    if(color.startsWith("rgba(")) return color;
    return `rgba(255,255,255,${a})`;
  }

  function normalizeColor(v){
    if(/^#([0-9a-f]{6})$/i.test(v)) return v;
    return "#000000";
  }

  function cssLengthToPx(raw, fallback){
    const val = (raw || "").trim();
    if(!val) return fallback;
    if(val.endsWith("px")) return parseFloat(val);
    if(val.endsWith("rem")){
      const fs = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
      return parseFloat(val) * fs;
    }
    const n = parseFloat(val);
    return Number.isFinite(n) ? n : fallback;
  }

  function colorToHex(value, fallback = "#000000"){
    const v = (value || "").trim();
    if(/^#([0-9a-f]{6})$/i.test(v)) return v;
    const m = v.match(/^rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
    if(m){
      const toHex = (n)=> Math.max(0, Math.min(255, parseInt(n, 10))).toString(16).padStart(2, "0");
      return `#${toHex(m[1])}${toHex(m[2])}${toHex(m[3])}`;
    }
    return fallback;
  }

  function clampNumber(n, min, max){
    if(!Number.isFinite(n)) return min;
    return Math.max(min, Math.min(max, n));
  }

  const CUSTOM_STYLE_VARS = [
    "--custom-cover-bg-color",
    "--custom-letter-bg-color",
    "--custom-cover-title-color",
    "--custom-cover-title-size",
    "--custom-cover-badge-color",
    "--custom-cover-badge-size",
    "--custom-cover-author-color",
    "--custom-cover-author-size",
    "--custom-cover-image-opacity",
    "--custom-meta-color",
    "--custom-meta-size",
    "--custom-card-box-color",
    "--custom-card-box-opacity",
    "--custom-card-box-bg",
    "--custom-deco-color",
    "--custom-letter-color",
    "--custom-letter-size",
    "--custom-word-color",
    "--custom-word-size",
    "--custom-trans-color",
    "--custom-trans-size",
    "--custom-body-color",
    "--custom-body-size"
  ];

  function clearCustomStyleVars(){
    if(!previewScope) return;
    CUSTOM_STYLE_VARS.forEach((k)=> previewScope.style.removeProperty(k));
  }

  function syncFineTuneControls(resetToTheme = false){
    if(!previewScope) return;
    const css = getComputedStyle(previewScope);
    const pickColor = (key, cssFallback, hardFallback)=>{
      const src = (!resetToTheme && state.vars[key]) ? state.vars[key] : (css.getPropertyValue(cssFallback).trim() || hardFallback);
      return colorToHex(src, hardFallback);
    };
    const pickPx = (key, el, min, max, fallback)=>{
      const fromState = !resetToTheme ? parseInt(state.vars[key], 10) : NaN;
      const fromCss = parseInt(getComputedStyle(el).fontSize, 10);
      return clampNumber(Number.isFinite(fromState) ? fromState : (Number.isFinite(fromCss) ? fromCss : fallback), min, max);
    };

    const coverBgColorVal = pickColor("--custom-cover-bg-color", "--color-background", "#101722");
    const letterBgColorVal = pickColor("--custom-letter-bg-color", "--color-background", "#101722");
    const coverTitleColorVal = pickColor("--custom-cover-title-color", "--color-cover-title", "#ffffff");
    const coverBadgeColorVal = pickColor("--custom-cover-badge-color", "--color-cover-badge", "#ffffff");
    const coverAuthorColorVal = pickColor("--custom-cover-author-color", "--color-cover-author", "#dddddd");
    const metaColorVal = pickColor("--custom-meta-color", "--color-text-secondary", "#9aa4b8");
    const boxColorVal = pickColor("--custom-card-box-color", "--color-surface", "#ffffff");
    const decoColorVal = pickColor("--custom-deco-color", "--color-border", "#cccccc");
    const letterColorVal = pickColor("--custom-letter-color", "--color-accent", "#7aa8ff");
    const wordColorVal = pickColor("--custom-word-color", "--color-primary", "#1a1a1a");
    const transColorVal = pickColor("--custom-trans-color", "--color-text-secondary", "#9aa4b8");
    const bodyColorVal = pickColor("--custom-body-color", "--color-text", "#1a1a1a");

    const titleSizeVal = pickPx("--custom-cover-title-size", pvTitle, 18, 80, 42);
    const badgeSizeVal = pickPx("--custom-cover-badge-size", pvBadge, 10, 34, 14);
    const authorSizeVal = pickPx("--custom-cover-author-size", pvAuthor, 10, 34, 16);
    const metaSizeVal = pickPx("--custom-meta-size", pvMetaTitle, 10, 30, 13);
    const letterSizeVal = pickPx("--custom-letter-size", pvLetter, 20, 130, 44);
    const wordSizeVal = pickPx("--custom-word-size", pvWord, 12, 56, 22);
    const transSizeVal = pickPx("--custom-trans-size", pvTrans, 12, 30, 16);
    const bodySizeVal = pickPx("--custom-body-size", pvPara, 12, 36, 16);

    const opFromState = !resetToTheme ? parseFloat(state.vars["--custom-cover-image-opacity"]) : NaN;
    const coverOpacityVal = clampNumber(Math.round((Number.isFinite(opFromState) ? opFromState : 1) * 100), 0, 100);
    const boxOpFromState = !resetToTheme ? parseFloat(state.vars["--custom-card-box-opacity"]) : NaN;
    const boxOpacityVal = clampNumber(Math.round((Number.isFinite(boxOpFromState) ? boxOpFromState : 1) * 100), 0, 100);

    coverBgColor.value = coverBgColorVal;
    letterBgColor.value = letterBgColorVal;
    coverTitleColor.value = coverTitleColorVal;
    coverBadgeColor.value = coverBadgeColorVal;
    coverAuthorColor.value = coverAuthorColorVal;
    metaColor.value = metaColorVal;
    cardBoxColor.value = boxColorVal;
    decoColor.value = decoColorVal;
    letterColor.value = letterColorVal;
    wordColorFine.value = wordColorVal;
    transColorFine.value = transColorVal;
    bodyColorFine.value = bodyColorVal;

    coverTitleSize.value = `${titleSizeVal}`;
    coverBadgeSize.value = `${badgeSizeVal}`;
    coverAuthorSize.value = `${authorSizeVal}`;
    metaSize.value = `${metaSizeVal}`;
    letterSize.value = `${letterSizeVal}`;
    wordSizeFine.value = `${wordSizeVal}`;
    bodySize.value = `${transSizeVal}`;
    bodySizeFine.value = `${bodySizeVal}`;
    coverImageOpacity.value = `${coverOpacityVal}`;
    cardBoxOpacity.value = `${boxOpacityVal}`;

    coverTitleSizeLabel.textContent = `${titleSizeVal}px`;
    coverBadgeSizeLabel.textContent = `${badgeSizeVal}px`;
    coverAuthorSizeLabel.textContent = `${authorSizeVal}px`;
    metaSizeLabel.textContent = `${metaSizeVal}px`;
    letterSizeLabel.textContent = `${letterSizeVal}px`;
    wordSizeFineLabel.textContent = `${wordSizeVal}px`;
    bodySizeLabel.textContent = `${transSizeVal}px`;
    bodySizeFineLabel.textContent = `${bodySizeVal}px`;
    coverImageOpacityLabel.textContent = `${coverOpacityVal}%`;
    cardBoxOpacityLabel.textContent = `${boxOpacityVal}%`;

    setVar("--custom-cover-bg-color", coverBgColorVal);
    setVar("--custom-letter-bg-color", letterBgColorVal);
    setVar("--custom-cover-title-color", coverTitleColorVal);
    setVar("--custom-cover-title-size", `${titleSizeVal}px`);
    setVar("--custom-cover-badge-color", coverBadgeColorVal);
    setVar("--custom-cover-badge-size", `${badgeSizeVal}px`);
    setVar("--custom-cover-author-color", coverAuthorColorVal);
    setVar("--custom-cover-author-size", `${authorSizeVal}px`);
    setVar("--custom-cover-image-opacity", `${coverOpacityVal / 100}`);
    setVar("--custom-meta-color", metaColorVal);
    setVar("--custom-meta-size", `${metaSizeVal}px`);
    setVar("--custom-card-box-color", boxColorVal);
    setVar("--custom-card-box-opacity", `${boxOpacityVal / 100}`);
    setVar("--custom-card-box-bg", rgba(boxColorVal, boxOpacityVal / 100));
    setVar("--custom-deco-color", decoColorVal);
    setVar("--custom-letter-color", letterColorVal);
    setVar("--custom-letter-size", `${letterSizeVal}px`);
    setVar("--custom-word-color", wordColorVal);
    setVar("--custom-word-size", `${wordSizeVal}px`);
    setVar("--custom-trans-color", transColorVal);
    setVar("--custom-trans-size", `${transSizeVal}px`);
    setVar("--custom-body-color", bodyColorVal);
    setVar("--custom-body-size", `${bodySizeVal}px`);
  }

  function readThemeVarsFromCss(themeId){
    if(!themeProbe){
      return {...FALLBACK_VARS};
    }
    themeProbe.setAttribute("data-theme", themeId);
    const css = getComputedStyle(themeProbe);

    const bg = css.getPropertyValue("--color-background").trim() || FALLBACK_VARS["--bg"];
    const card = css.getPropertyValue("--color-surface").trim() || FALLBACK_VARS["--card"];
    const text = css.getPropertyValue("--color-text").trim() || FALLBACK_VARS["--text"];
    const muted = css.getPropertyValue("--color-text-secondary").trim() || FALLBACK_VARS["--muted"];
    const accent = css.getPropertyValue("--color-accent").trim() || FALLBACK_VARS["--accent"];
    const fontFamily = css.getPropertyValue("--font-family").trim() || FALLBACK_VARS["--fontBody"];
    const titleSizePx = cssLengthToPx(css.getPropertyValue("--font-size-title"), 28);
    const bodySizePx = cssLengthToPx(css.getPropertyValue("--font-size-body"), 16);
    const radiusPx = cssLengthToPx(css.getPropertyValue("--radius-card"), 18);
    const lineHeight = parseFloat(css.getPropertyValue("--line-height-body").trim()) || 1.7;
    const border = css.getPropertyValue("--color-border").trim() || "rgba(255,255,255,.08)";
    const shadow = css.getPropertyValue("--shadow-card").trim() || FALLBACK_VARS["--shadow"];

    return {
      "--bg": bg,
      "--card": card,
      "--text": text,
      "--muted": muted,
      "--accent": accent,
      "--titleSize": `${Math.round(titleSizePx)}px`,
      "--bodySize": `${Math.round(bodySizePx)}px`,
      "--radius": `${Math.round(radiusPx)}px`,
      "--lineHeight": `${lineHeight}`,
      "--fontTitle": fontFamily,
      "--fontBody": fontFamily,
      "--bd": border,
      "--shadow": shadow,
      "--color-background": bg,
      "--color-surface": card,
      "--color-text": text,
      "--color-text-secondary": muted,
      "--color-accent": accent,
      "--font-family": fontFamily,
      "--radius-card": `${Math.round(radiusPx)}px`,
      "--line-height-body": `${lineHeight}`,
      "--font-size-title": css.getPropertyValue("--font-size-title").trim() || `${Math.round(titleSizePx)/16}rem`,
      "--font-size-subtitle": css.getPropertyValue("--font-size-subtitle").trim() || `${Math.max(1, Math.round(titleSizePx*0.62))/16}rem`,
      "--font-size-body": css.getPropertyValue("--font-size-body").trim() || `${Math.round(bodySizePx)/16}rem`,
      "--font-size-small": css.getPropertyValue("--font-size-small").trim() || `${Math.max(0.75, Math.round(bodySizePx*0.85)/16)}rem`
    };
  }

  function applyPreviewBackground(){
    if(!previewScope) return;
    const coverUrl = state.coverBgImageRuntimeUrl || state.coverBgImageData || "";
    const letterUrl = state.letterBgImageRuntimeUrl || state.letterBgImageData || "";
    const hasCoverBg = Boolean(state.coverBgImageEnabled && coverUrl);
    const hasLetterBg = Boolean(state.letterBgImageEnabled && letterUrl);
    const coverSafeUrl = hasCoverBg ? `url("${String(coverUrl).replace(/"/g, "%22")}")` : "none";
    const letterSafeUrl = hasLetterBg ? `url("${String(letterUrl).replace(/"/g, "%22")}")` : "none";

    // Keep preview container clean: uploaded background only affects export frames.
    previewScope.style.setProperty("--background-image", "none");
    previewScope.style.backgroundImage = "";
    previewScope.style.backgroundSize = "";
    previewScope.style.backgroundPosition = "";

    if(coverFrame){
      coverFrame.style.setProperty("--background-image", coverSafeUrl);
      coverFrame.style.setProperty("--background-size", "cover");
      coverFrame.style.setProperty("--background-position", "center");
      if(hasCoverBg){
        coverFrame.style.backgroundImage = `linear-gradient(rgba(0,0,0,.14), rgba(0,0,0,.14)), ${coverSafeUrl}, var(--gradient-cover)`;
        coverFrame.style.backgroundSize = "cover, cover, 100% 100%";
        coverFrame.style.backgroundPosition = "center, center, 0 0";
      }else{
        coverFrame.style.backgroundImage = "var(--gradient-cover)";
        coverFrame.style.backgroundSize = "100% 100%";
        coverFrame.style.backgroundPosition = "0 0";
      }
    }
    if(letterFrame){
      letterFrame.style.setProperty("--background-image", letterSafeUrl);
      letterFrame.style.setProperty("--background-size", "cover");
      letterFrame.style.setProperty("--background-position", "center");
      letterFrame.style.backgroundColor = "var(--custom-letter-bg-color, var(--color-background))";
      if(hasLetterBg){
        letterFrame.style.backgroundImage = `linear-gradient(rgba(255,255,255,.06), rgba(255,255,255,.06)), ${letterSafeUrl}, var(--gradient-decoration)`;
        letterFrame.style.backgroundSize = "cover, cover, 100% 100%";
        letterFrame.style.backgroundPosition = "center, center, 0 0";
      }else{
        letterFrame.style.backgroundImage = "var(--gradient-decoration)";
        letterFrame.style.backgroundSize = "100% 100%";
        letterFrame.style.backgroundPosition = "0 0";
      }
    }
  }

  function revokeObjectUrl(key){
    if(state[key]){
      try{
        URL.revokeObjectURL(state[key]);
      }catch(_){}
      state[key] = "";
    }
  }

  function applyCoverImage(){
    if(!coverFrame || !coverImagePreview) return;
    const hasImage = Boolean(state.coverImageEnabled && state.coverImageData);
    coverFrame.classList.toggle("az-cover--has-image", hasImage);
    if(hasImage){
      if(coverImagePreview.src !== state.coverImageData){
        coverImagePreview.src = state.coverImageData;
      }
      coverImagePreview.hidden = false;
      coverImagePreview.alt = "封面头图";
    }else{
      coverImagePreview.src = "";
      coverImagePreview.hidden = true;
    }
  }

  function pickWord(style, letter){
    const pool = (STYLE_OVERRIDES[style] && STYLE_OVERRIDES[style][letter]) || GENERIC[letter] || [["Word","单词"]];
    const [en, zh] = pool[Math.floor(Math.random()*pool.length)];
    return {en, zh};
  }

  function ensureDefaultsIfEmpty(){
    const it = state.items[state.current];
    if(!it.en && !it.zh){
      const w = pickWord(state.style, state.current);
      it.en = w.en; it.zh = w.zh;
    }
  }

  function countDone(){
    let done = 0;
    letters.forEach(L=>{
      if((state.items[L].text || "").trim().length > 0) done++;
    });
    return done;
  }

  function updateProgress(){
    progressPill.textContent = `完成度 ${countDone()}/26`;
  }

  function renderAZ(){
    azList.innerHTML = "";
    letters.forEach(L=>{
      const b = document.createElement("div");
      b.className = "azBtn";
      if(L === state.current) b.classList.add("active");
      if(state.items[L].locked) b.classList.add("locked");
      b.textContent = L;
      const dot = document.createElement("span");
      dot.className = "lockDot";
      b.appendChild(dot);
      b.addEventListener("click", ()=>{
        saveCurrentEdits();
        state.current = L;
        loadCurrentEdits();
        renderAZ();
        renderPreview();
      });
      azList.appendChild(b);
    });
    renderWordList();
  }

  function renderWordList(){
    if(!wordList) return;
    wordList.innerHTML = "";
    letters.forEach((L)=>{
      const it = state.items[L] || {en:"", zh:"", locked:false};
      const row = document.createElement("div");
      row.className = "wordRow" + (L === state.current ? " active" : "");
      const en = (it.en || "").trim() || "（未设置英文）";
      const zh = (it.zh || "").trim() || "（未设置中文翻译）";
      row.innerHTML = `
        <div class="wordRowTop">
          <span class="wordRowLetter">${L}${it.locked ? " · 锁" : ""}</span>
          <span class="wordRowEn">${en}</span>
        </div>
        <div class="wordRowZh">${zh}</div>
      `;
      row.addEventListener("click", ()=>{
        saveCurrentEdits();
        state.current = L;
        loadCurrentEdits();
        renderAZ();
        renderPreview();
      });
      wordList.appendChild(row);
    });
  }

  function saveCurrentEdits(){
    const it = state.items[state.current];
    it.en = wordEn.value.trim();
    it.zh = wordZh.value.trim();
    it.text = entryText.value;
  }

  function loadCurrentEdits(){
    const it = state.items[state.current];
    curLetter.textContent = state.current;
    wordEn.value = it.en || "";
    wordZh.value = it.zh || "";
    entryText.value = it.text || "";
    lockPill.textContent = it.locked ? "已锁定" : "未锁定";
    lockPill.style.borderColor = it.locked ? "rgba(255,122,176,.45)" : "rgba(255,255,255,.12)";
    $("countInfo").textContent = `字数：${(it.text||"").replace(/\s/g,"").length}`;
  }

  function renderPreview(){
    const it = state.items[state.current];
    pvLetter.textContent = state.current;
    if(pvCardWrap) pvCardWrap.setAttribute("data-letter", state.current);
    pvWord.textContent = it.en || "（英文单词）";
    pvTrans.textContent = it.zh || "（中文翻译）";
    pvPara.textContent = (it.text && it.text.trim()) ? it.text : "（在左侧输入你的段落）";

    const title = ($("projectTitle").value || "").trim() || state.projectTitle;
    const author = ($("projectAuthor").value || "").trim();
    const subtitle = (projectSubtitleInput.value || "").trim() || state.projectSubtitle;
    const watermark = (projectWatermarkInput.value || "").trim() || state.projectWatermark;

    if(pvBadge) pvBadge.textContent = subtitle;
    pvTitle.textContent = title;
    pvAuthor.textContent = author ? `作者：${author}` : "作者：—";
    if(pvCoverSubtitle){
      pvCoverSubtitle.textContent = "";
      pvCoverSubtitle.style.display = "none";
    }
    if(pvMetaTitle && pvMetaTitle.value !== subtitle) pvMetaTitle.value = subtitle;
    if(pvMetaAuthor && pvMetaAuthor.value !== (author ? `作者：${author}` : "作者：—")) pvMetaAuthor.value = author ? `作者：${author}` : "作者：—";
    if(pvWatermark && pvWatermark.value !== watermark) pvWatermark.value = watermark;

    syncPreviewAspect();
    applyPreviewBackground();
    applyCoverImage();
    renderWordList();
    updateProgress();
  }

  function applyTheme(themeId){
    state.theme = THEME_IDS.includes(themeId) ? themeId : "light";
    const base = readThemeVarsFromCss(state.theme);
    state.vars = {...base};
    if(previewScope){
      previewScope.setAttribute("data-theme", state.theme);
      clearCustomStyleVars();
      previewScope.style.removeProperty("--gradient-cover");
    }
    setCSSVars(state.vars);

    coverBgColor.value = normalizeColor(state.vars["--custom-cover-bg-color"] || state.vars["--bg"] || "#101722");
    letterBgColor.value = normalizeColor(state.vars["--custom-letter-bg-color"] || state.vars["--bg"] || "#101722");
    transColorFine.value = normalizeColor(state.vars["--custom-trans-color"] || state.vars["--muted"] || "#9aa4b8");

    bodySize.value = parseInt(state.vars["--custom-trans-size"],10) || 16;
    radius.value = parseInt(state.vars["--radius"],10) || 18;

    bodySizeLabel.textContent = `${bodySize.value}px`;
    radiusLabel.textContent = `${radius.value}px`;
    syncFineTuneControls(true);
    $("themeSelect").value = state.theme;
    showToast("已切换主题，并重置变量为默认。");
  }

  function setVar(k, v){
    state.vars[k] = v;
    const target = previewScope || document.documentElement;
    target.style.setProperty(k, v);
    const map = {
      "--bg":"--color-background",
      "--card":"--color-surface",
      "--text":"--color-text",
      "--muted":"--color-text-secondary",
      "--accent":"--color-accent",
      "--radius":"--radius-card",
      "--fontBody":"--font-family"
    };
    if(map[k]){
      state.vars[map[k]] = v;
      target.style.setProperty(map[k], v);
    }
    if(k === "--titleSize"){
      const px = parseInt(v, 10);
      if(Number.isFinite(px)){
        const rem = `${Math.max(12, px)/16}rem`;
        state.vars["--font-size-title"] = rem;
        target.style.setProperty("--font-size-title", rem);
      }
    }
    if(k === "--bg"){
      // make cover background react to bg color picker directly
      const coverGrad = `linear-gradient(180deg, ${v} 0%, ${v} 100%)`;
      state.vars["--gradient-cover"] = coverGrad;
      target.style.setProperty("--gradient-cover", coverGrad);
    }
    if(k === "--custom-cover-bg-color"){
      const coverGrad = `linear-gradient(180deg, ${v} 0%, ${v} 100%)`;
      state.vars["--gradient-cover"] = coverGrad;
      target.style.setProperty("--gradient-cover", coverGrad);
    }
    if(k === "--custom-letter-bg-color"){
      state.vars["--color-background"] = v;
      target.style.setProperty("--color-background", v);
    }
  }

  function setFrameBackgroundImageData(kind, dataUrl){
    const isCover = kind === "cover";
    const dataKey = isCover ? "coverBgImageData" : "letterBgImageData";
    const runtimeKey = isCover ? "coverBgImageRuntimeUrl" : "letterBgImageRuntimeUrl";
    const objectKey = isCover ? "coverBgImageObjectUrl" : "letterBgImageObjectUrl";
    const elKey = isCover ? "coverBgImageEl" : "letterBgImageEl";

    revokeObjectUrl(objectKey);
    state[dataKey] = dataUrl || "";
    state[runtimeKey] = state[dataKey];
    state[elKey] = null;
    applyPreviewBackground();
    if(!state[dataKey]){
      return;
    }
    const img = new Image();
    img.onload = ()=>{
      state[elKey] = img;
      applyPreviewBackground();
    };
    img.onerror = ()=>{
      state[dataKey] = "";
      state[runtimeKey] = "";
      state[elKey] = null;
      applyPreviewBackground();
      showToast(isCover ? "封面背景图加载失败。" : "卡片页背景图加载失败。");
    };
    img.src = state[dataKey];
  }

  function setFrameBackgroundImageFile(kind, file){
    if(!file) return;
    const isCover = kind === "cover";
    const dataKey = isCover ? "coverBgImageData" : "letterBgImageData";
    const runtimeKey = isCover ? "coverBgImageRuntimeUrl" : "letterBgImageRuntimeUrl";
    const objectKey = isCover ? "coverBgImageObjectUrl" : "letterBgImageObjectUrl";
    const elKey = isCover ? "coverBgImageEl" : "letterBgImageEl";
    revokeObjectUrl(objectKey);

    state[dataKey] = "";
    state[elKey] = null;
    try{
      state[objectKey] = URL.createObjectURL(file);
      state[runtimeKey] = state[objectKey];
    }catch(_){
      state[objectKey] = "";
      state[runtimeKey] = "";
    }

    applyPreviewBackground();

    if(state[runtimeKey]){
      const img = new Image();
      img.onload = ()=>{ state[elKey] = img; };
      img.onerror = ()=>{ showToast(isCover ? "封面背景图预览失败，请换一张图片。" : "卡片页背景图预览失败，请换一张图片。"); };
      img.src = state[runtimeKey];
    }

    if(!isCover && letterFrame){
      const safeUrl = state[runtimeKey] ? `url("${String(state[runtimeKey]).replace(/"/g, "%22")}")` : "none";
      letterFrame.style.setProperty("--background-image", safeUrl);
    }

    const reader = new FileReader();
    reader.onload = ()=>{
      state[dataKey] = String(reader.result || "");
      if(!state[runtimeKey]){
        state[runtimeKey] = state[dataKey];
        applyPreviewBackground();
      }
    };
    reader.onerror = ()=>{};
    reader.readAsDataURL(file);
  }

  function setCoverImageData(dataUrl){
    state.coverImageData = dataUrl || "";
    if(!state.coverImageData){
      applyCoverImage();
      return;
    }
    const img = new Image();
    img.onload = ()=> applyCoverImage();
    img.onerror = ()=>{
      state.coverImageData = "";
      applyCoverImage();
      showToast("封面头图加载失败。");
    };
    img.src = state.coverImageData;
  }

  function generateAZ(){
    letters.forEach(L=>{
      const it = state.items[L];
      if(it.locked) return;
      const w = pickWord(state.style, L);
      it.en = w.en;
      it.zh = w.zh;
    });
    loadCurrentEdits();
    renderAZ();
    renderPreview();
    showToast("已为未锁定字母随机生成 A–Z 单词与翻译。");
  }

  function fillDemoText(){
    letters.forEach(L=>{
      const it = state.items[L];
      if((it.text||"").trim()) return;
      const en = it.en || L;
      it.text = `围绕「${en}」写一段：\n\n他（她）在那一刻终于明白，所谓主题并不是束缚，而是一条能把碎片串起来的线。每一个字母都像一扇门，推开之后，是不同的光。`;
    });
    loadCurrentEdits();
    renderPreview();
    showToast("已为未写段落填入示例文本（可随时改）。");
  }

  function clearAllText(){
    if(!confirm("确定要清空全部 26 段文本吗？（单词不清空）")) return;
    letters.forEach(L=> state.items[L].text = "");
    loadCurrentEdits();
    renderPreview();
    updateProgress();
    showToast("已清空全部段落。");
  }

  function toggleLockCurrent(){
    state.items[state.current].locked = !state.items[state.current].locked;
    renderAZ();
    loadCurrentEdits();
    showToast(state.items[state.current].locked ? "已锁定当前字母" : "已解锁当前字母");
  }
  function lockAll(v){
    letters.forEach(L=> state.items[L].locked = v);
    renderAZ();
    loadCurrentEdits();
    showToast(v ? "已全锁定" : "已全部解锁");
  }

  // ---------- Canvas helpers ----------
  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const lines = [];
    const paragraphs = String(text||"").split("\n");
    paragraphs.forEach((p, idx)=>{
      const tokens = p.split(/(\s+)/).filter(s=>s.length>0);
      let line = "";
      for(let i=0;i<tokens.length;i++){
        const test = line + tokens[i];
        const w = ctx.measureText(test).width;
        if(w > maxWidth && line.trim().length>0){
          lines.push(line.replace(/\s+$/,""));
          line = tokens[i].trimStart();
        }else{
          line = test;
        }
      }
      if(line.length) lines.push(line.replace(/\s+$/,""));
      if(idx !== paragraphs.length-1) lines.push("");
    });

    let yy = y;
    lines.forEach(ln=>{
      if(ln==="") yy += lineHeight;
      else { ctx.fillText(ln, x, yy); yy += lineHeight; }
    });
    return yy;
  }

  function getExportSpec(){
    const [wStr,hStr] = $("sizePreset").value.split("x");
    const W = parseInt(wStr,10), H = parseInt(hStr,10);
    const vars = state.vars || FALLBACK_VARS;
    return {
      W,H,
      bg: vars["--bg"] || "#000000",
      card: vars["--card"] || "#111111",
      text: vars["--text"] || "#ffffff",
      muted: vars["--muted"] || "#aaaaaa",
      accent: vars["--accent"] || "#7aa8ff",
      titleSizePx: parseInt(vars["--titleSize"],10) || 28,
      bodySizePx: parseInt(vars["--bodySize"],10) || 16,
      radiusPx: parseInt(vars["--radius"],10) || 18,
      fontTitle: vars["--fontTitle"] || "Georgia, serif",
      fontBody: vars["--fontBody"] || "system-ui, -apple-system, Segoe UI, Roboto, Arial"
    };
  }

  function downloadCanvas(canvas, filename){
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function safeTitle(){
    const t = ($("projectTitle").value || "").trim() || state.projectTitle || "AZ";
    return t.replace(/[\\/:*?"<>|]+/g,"_").slice(0,40);
  }

  function drawImageCover(ctx, img, W, H){
    if(!img) return;
    const scale = Math.max(W / img.width, H / img.height);
    const dw = img.width * scale;
    const dh = img.height * scale;
    const dx = (W - dw) / 2;
    const dy = (H - dh) / 2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function drawBackgroundBase(ctx, spec){
    const {W,H,bg} = spec;
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);
    const legacyBg = (state.coverBgImageEnabled && state.coverBgImageEl)
      ? state.coverBgImageEl
      : ((state.letterBgImageEnabled && state.letterBgImageEl) ? state.letterBgImageEl : null);
    if(legacyBg){
      drawImageCover(ctx, legacyBg, W, H);
      ctx.fillStyle = rgba(bg, 0.38);
      ctx.fillRect(0,0,W,H);
    }
  }

  // ---------- Export Builders ----------
  function buildCoverCanvas(spec = getExportSpec()){
    const {W,H,card,text,muted,accent,radiusPx,fontTitle,fontBody} = spec;
    const title = ($("projectTitle").value || "").trim() || state.projectTitle;
    const author = ($("projectAuthor").value || "").trim();
    const styleName = state.style[0].toUpperCase()+state.style.slice(1);

    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext("2d");

    drawBackgroundBase(ctx, spec);

    const g1 = ctx.createRadialGradient(W*0.22, H*0.18, 0, W*0.22, H*0.18, Math.max(W,H)*0.60);
    g1.addColorStop(0, rgba(accent, 0.22));
    g1.addColorStop(1, rgba(accent, 0));
    ctx.fillStyle = g1;
    ctx.fillRect(0,0,W,H);

    const g2 = ctx.createRadialGradient(W*0.82, H*0.35, 0, W*0.82, H*0.35, Math.max(W,H)*0.55);
    g2.addColorStop(0, "rgba(255,122,176,.10)");
    g2.addColorStop(1, "rgba(255,122,176,0)");
    ctx.fillStyle = g2;
    ctx.fillRect(0,0,W,H);

    const pad = Math.round(W*0.07);
    const cardX = pad, cardY = pad, cardW = W-pad*2, cardH = H-pad*2;

    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,.35)";
    ctx.shadowBlur = Math.round(W*0.03);
    ctx.shadowOffsetY = Math.round(W*0.008);
    roundRect(ctx, cardX, cardY, cardW, cardH, radiusPx+10);
    ctx.fillStyle = card;
    ctx.fill();
    ctx.restore();

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = Math.max(1, Math.round(W/1100));
    roundRect(ctx, cardX, cardY, cardW, cardH, radiusPx+10);
    ctx.stroke();

    const x = cardX + Math.round(cardW*0.08);
    let y = cardY + Math.round(cardH*0.18);

    const tagW = Math.round(cardW*0.22);
    const tagH = Math.round(H*0.045);
    ctx.fillStyle = rgba(accent, 0.20);
    roundRect(ctx, x, y, tagW, tagH, Math.round(tagH/2));
    ctx.fill();
    ctx.strokeStyle = rgba(accent, 0.35);
    ctx.stroke();

    ctx.fillStyle = rgba(text, 0.92);
    ctx.font = `650 ${Math.round(H*0.020)}px ${fontBody}`;
    ctx.textBaseline = "middle";
    ctx.textAlign = "left";
    ctx.fillText("A–Z STORY COLLECTION", x + Math.round(tagH*0.55), y + tagH/2);

    y += tagH + Math.round(H*0.06);

    ctx.fillStyle = rgba(text, 0.98);
    ctx.font = `750 ${Math.round(H*0.060)}px ${fontTitle}`;
    ctx.textBaseline = "top";
    ctx.fillText(title || "A–Z 主题短篇集", x, y);

    y += Math.round(H*0.10);
    ctx.fillStyle = muted;
    ctx.font = `500 ${Math.round(H*0.024)}px ${fontBody}`;
    const dateStr = new Date().toLocaleDateString("zh-CN", {year:"numeric", month:"2-digit", day:"2-digit"});
    ctx.fillText(author ? `作者：${author}` : "作者：—", x, y);
    y += Math.round(H*0.040);
    ctx.fillText(`风格：${styleName}  ·  完成度：${countDone()}/26`, x, y);
    y += Math.round(H*0.040);
    ctx.fillText(`日期：${dateStr}`, x, y);

    ctx.fillStyle = rgba(text, 0.18);
    ctx.font = `700 ${Math.round(H*0.055)}px ${fontBody}`;
    ctx.fillText("A  •  B  •  C  •  …  •  Z", x, cardY + cardH - Math.round(H*0.18));

    ctx.fillStyle = rgba(text, 0.70);
    ctx.font = `600 ${Math.round(H*0.020)}px ${fontBody}`;
    ctx.fillText("Generated by A–Z Word Writer", x, cardY + cardH - Math.round(H*0.10));

    return canvas;
  }

  function exportCoverPNG(){
    saveCurrentEdits();
    downloadCanvas(buildCoverCanvas(getExportSpec()), `${safeTitle()}-00-Cover.png`);
    showToast("已开始下载封面 PNG。");
  }

  function buildLetterCanvas(letter, spec = getExportSpec()){
    const {W,H,card,text,muted,accent,titleSizePx,bodySizePx,radiusPx,fontTitle,fontBody} = spec;
    const it = state.items[letter] || {en:"", zh:"", text:""};

    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext("2d");

    drawBackgroundBase(ctx, spec);

    const g = ctx.createRadialGradient(W*0.82, H*0.12, 0, W*0.82, H*0.12, Math.max(W,H)*0.45);
    g.addColorStop(0, rgba(accent, 0.22));
    g.addColorStop(1, rgba(accent, 0));
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    const pad = Math.round(W * 0.06);
    const cardPad = Math.round(W * 0.045);
    const cardX = pad, cardY = pad, cardW = W - pad*2, cardH = H - pad*2;

    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,.35)";
    ctx.shadowBlur = Math.round(W*0.02);
    ctx.shadowOffsetY = Math.round(W*0.006);
    roundRect(ctx, cardX, cardY, cardW, cardH, radiusPx + 6);
    ctx.fillStyle = card;
    ctx.fill();
    ctx.restore();

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = Math.max(1, Math.round(W/900));
    roundRect(ctx, cardX, cardY, cardW, cardH, radiusPx + 6);
    ctx.stroke();

    let x = cardX + cardPad;
    let y = cardY + cardPad;

    const badge = Math.round(W * 0.09);
    const badgeR = Math.round(badge * 0.28);
    ctx.fillStyle = rgba(accent, 0.25);
    roundRect(ctx, x, y, badge, badge, badgeR);
    ctx.fill();
    ctx.strokeStyle = rgba(accent, 0.35);
    ctx.stroke();

    ctx.fillStyle = text;
    ctx.font = `700 ${Math.round(badge*0.50)}px Georgia, serif`;
    ctx.textBaseline = "middle";
    ctx.textAlign = "center";
    ctx.fillText(letter, x + badge/2, y + badge/2 + 1);

    const title = ($("projectTitle").value || "").trim() || state.projectTitle;
    const author = ($("projectAuthor").value || "").trim();
    ctx.textAlign = "right";
    ctx.textBaseline = "top";
    ctx.fillStyle = rgba(text, 0.92);
    ctx.font = `650 ${Math.round(W*0.022)}px ${fontBody}`;
    ctx.fillText(title, cardX + cardW - cardPad, y);

    ctx.fillStyle = muted;
    ctx.font = `500 ${Math.round(W*0.017)}px ${fontBody}`;
    ctx.fillText(author ? `作者：${author}` : "作者：—", cardX + cardW - cardPad, y + Math.round(W*0.03));

    y += badge + Math.round(W*0.02);

    ctx.textAlign = "left";
    ctx.fillStyle = rgba(text, 0.98);
    ctx.font = `700 ${titleSizePx}px ${fontTitle}`;
    ctx.textBaseline = "top";
    ctx.fillText(it.en || "（英文单词）", x, y);
    y += titleSizePx + Math.round(W*0.01);

    ctx.fillStyle = muted;
    ctx.font = `500 ${Math.round(bodySizePx*0.92)}px ${fontBody}`;
    ctx.fillText(it.zh || "（中文翻译）", x, y);
    y += Math.round(bodySizePx*1.4);

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = Math.max(1, Math.round(W/1100));
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(cardX + cardW - cardPad, y);
    ctx.stroke();
    y += Math.round(bodySizePx*1.2);

    const para = (it.text && it.text.trim()) ? it.text : "（在左侧输入你的段落）";
    ctx.fillStyle = rgba(text, 0.92);
    ctx.font = `400 ${bodySizePx}px ${fontBody}`;
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    const maxTextW = cardX + cardW - cardPad - x;
    const lineH = Math.round(bodySizePx * 1.65);
    wrapText(ctx, para, x, y, maxTextW, lineH);

    const footerY = cardY + cardH - cardPad - Math.round(W*0.022);
    const styleName = state.style[0].toUpperCase()+state.style.slice(1);
    ctx.fillStyle = muted;
    ctx.font = `500 ${Math.round(W*0.016)}px ${fontBody}`;
    ctx.textBaseline = "top";
    ctx.textAlign = "left";
    ctx.fillText(`Style: ${styleName}`, x, footerY);
    ctx.textAlign = "right";
    ctx.fillText(`${letter} / Z`, cardX + cardW - cardPad, footerY);

    return canvas;
  }

  function exportLetterPNG(letter){
    saveCurrentEdits();
    downloadCanvas(buildLetterCanvas(letter, getExportSpec()), `${safeTitle()}-${letter}.png`);
  }

  function getWrappedLines(ctx, text, maxWidth){
    const lines = [];
    const paragraphs = String(text || "").split("\n");
    paragraphs.forEach((p, idx)=>{
      const tokens = p.split(/(\s+)/).filter(s=>s.length>0);
      let line = "";
      for(let i=0;i<tokens.length;i++){
        const test = line + tokens[i];
        if(ctx.measureText(test).width > maxWidth && line.trim().length > 0){
          lines.push(line.replace(/\s+$/,""));
          line = tokens[i].trimStart();
        }else{
          line = test;
        }
      }
      if(line.length) lines.push(line.replace(/\s+$/,""));
      if(idx !== paragraphs.length - 1) lines.push("");
    });
    return lines.length ? lines : [""];
  }

  function collectLongEntries(spec, maxBodyLines){
    const {W, bodySizePx, fontBody} = spec;
    const pad = Math.round(W * 0.06);
    const contentW = W - pad*2;
    const entryPad = Math.round(W * 0.03);
    const entryBodySize = Math.round(bodySizePx * 0.98);
    const bodyLineH = Math.max(22, Math.round(entryBodySize * 1.6));
    const headerH = Math.round(W * 0.07);
    const maxTextW = contentW - entryPad*2;

    const measureCanvas = document.createElement("canvas");
    measureCanvas.width = W;
    measureCanvas.height = 10;
    const mctx = measureCanvas.getContext("2d");
    mctx.font = `400 ${entryBodySize}px ${fontBody}`;

    const entries = letters.map((L)=>{
      const it = state.items[L] || {en:"", zh:"", text:""};
      let bodyLines = getWrappedLines(mctx, (it.text && it.text.trim()) ? it.text : "（未填写正文）", maxTextW);
      if(bodyLines.length > maxBodyLines){
        bodyLines = bodyLines.slice(0, maxBodyLines);
        const tail = bodyLines[bodyLines.length - 1] || "";
        bodyLines[bodyLines.length - 1] = tail.length > 2 ? `${tail.slice(0, Math.max(1, tail.length - 1))}…` : "…";
      }

      const bodyH = Math.max(bodyLineH * 2, bodyLines.length * bodyLineH);
      const entryH = entryPad + headerH + Math.round(W * 0.012) + bodyH + entryPad;
      return {
        letter: L,
        en: it.en || "（英文单词）",
        zh: it.zh || "（中文翻译）",
        bodyLines,
        entryH,
        headerH
      };
    });

    return { entries, pad, contentW, entryPad, bodyLineH };
  }

  function buildLongBodyCanvas(spec = getExportSpec()){
    const {W,card,text,muted,accent,radiusPx,bodySizePx,fontTitle,fontBody} = spec;
    const title = ($("projectTitle").value || "").trim() || state.projectTitle;
    const author = ($("projectAuthor").value || "").trim();
    const styleName = state.style[0].toUpperCase()+state.style.slice(1);

    let maxBodyLines = 8;
    let pack = collectLongEntries(spec, maxBodyLines);
    const gap = Math.round(W * 0.02);
    const headerH = Math.round(W * 0.34);
    let totalH = pack.pad + headerH + gap + pack.entries.reduce((sum, item)=>sum + item.entryH + gap, 0) + pack.pad;

    const MAX_CANVAS_H = 30000;
    while(totalH > MAX_CANVAS_H && maxBodyLines > 2){
      maxBodyLines -= 1;
      pack = collectLongEntries(spec, maxBodyLines);
      totalH = pack.pad + headerH + gap + pack.entries.reduce((sum, item)=>sum + item.entryH + gap, 0) + pack.pad;
    }

    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = Math.ceil(totalH);
    const ctx = canvas.getContext("2d");

    drawBackgroundBase(ctx, {...spec, H: canvas.height});

    const g1 = ctx.createRadialGradient(W*0.2, 0, 0, W*0.2, 0, W*0.9);
    g1.addColorStop(0, rgba(accent, 0.20));
    g1.addColorStop(1, rgba(accent, 0));
    ctx.fillStyle = g1;
    ctx.fillRect(0,0,W,canvas.height);

    const g2 = ctx.createRadialGradient(W*0.9, W*0.2, 0, W*0.9, W*0.2, W*0.8);
    g2.addColorStop(0, "rgba(255,122,176,.10)");
    g2.addColorStop(1, "rgba(255,122,176,0)");
    ctx.fillStyle = g2;
    ctx.fillRect(0,0,W,canvas.height);

    const topX = pack.pad;
    const topY = pack.pad;
    const topW = pack.contentW;
    roundRect(ctx, topX, topY, topW, headerH, radiusPx + 8);
    ctx.fillStyle = card;
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.stroke();

    const tx = topX + pack.entryPad;
    let ty = topY + pack.entryPad;
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillStyle = rgba(text, 0.96);
    ctx.font = `700 ${Math.round(W*0.055)}px ${fontTitle}`;
    ctx.fillText(title || "A–Z 主题短篇集", tx, ty);

    ty += Math.round(W * 0.075);
    ctx.fillStyle = muted;
    ctx.font = `500 ${Math.round(bodySizePx*1.05)}px ${fontBody}`;
    ctx.fillText(author ? `作者：${author}` : "作者：—", tx, ty);
    ty += Math.round(W * 0.035);
    ctx.fillText(`风格：${styleName}  ·  完成度：${countDone()}/26`, tx, ty);
    ty += Math.round(W * 0.035);
    ctx.fillText(`正文长图导出  ·  ${new Date().toLocaleDateString("zh-CN")}`, tx, ty);

    let y = topY + headerH + gap;
    pack.entries.forEach((item)=>{
      const x = pack.pad;
      const w = pack.contentW;
      const p = pack.entryPad;

      roundRect(ctx, x, y, w, item.entryH, radiusPx + 4);
      ctx.fillStyle = card;
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.stroke();

      const badge = Math.round(W * 0.07);
      roundRect(ctx, x + p, y + p, badge, badge, Math.round(badge*0.28));
      ctx.fillStyle = rgba(accent, 0.25);
      ctx.fill();
      ctx.strokeStyle = rgba(accent, 0.35);
      ctx.stroke();

      ctx.fillStyle = text;
      ctx.font = `700 ${Math.round(badge*0.50)}px Georgia, serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(item.letter, x + p + badge/2, y + p + badge/2 + 1);

      const hx = x + p + badge + Math.round(W * 0.02);
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillStyle = rgba(text, 0.98);
      ctx.font = `700 ${Math.round(bodySizePx*1.28)}px ${fontTitle}`;
      ctx.fillText(item.en, hx, y + p + Math.round(W * 0.004));

      ctx.fillStyle = muted;
      ctx.font = `500 ${Math.round(bodySizePx*0.95)}px ${fontBody}`;
      ctx.fillText(item.zh, hx, y + p + Math.round(W * 0.038));

      ctx.textAlign = "right";
      ctx.fillText(`${item.letter} / Z`, x + w - p, y + p + Math.round(W * 0.004));

      const bodyY = y + p + item.headerH + Math.round(W * 0.012);
      const bodyX = x + p;
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillStyle = rgba(text, 0.92);
      ctx.font = `400 ${Math.round(bodySizePx*0.98)}px ${fontBody}`;
      item.bodyLines.forEach((line, i)=>{
        ctx.fillText(line, bodyX, bodyY + i * pack.bodyLineH);
      });

      y += item.entryH + gap;
    });

    return canvas;
  }

  function exportLongPNG(){
    saveCurrentEdits();
    downloadCanvas(buildLongBodyCanvas(getExportSpec()), `${safeTitle()}-LongBody.png`);
    showToast("已开始下载正文长图 PNG。");
  }

  function canvasToBlob(canvas){
    return new Promise((resolve, reject)=>{
      canvas.toBlob((blob)=>{
        if(blob) resolve(blob);
        else reject(new Error("canvas.toBlob failed"));
      }, "image/png");
    });
  }

  async function exportZip(){
    saveCurrentEdits();
    if(typeof JSZip === "undefined"){
      showToast("JSZip 未加载，无法导出 ZIP。");
      return;
    }
    const spec = getExportSpec();
    const zip = new JSZip();
    showToast("正在打包封面+26字母，请稍候...");
    try{
      const coverBlob = await canvasToBlob(buildCoverCanvas(spec));
      zip.file(`${safeTitle()}-00-Cover.png`, coverBlob);

      for(let i=0;i<letters.length;i++){
        const L = letters[i];
        const letterBlob = await canvasToBlob(buildLetterCanvas(L, spec));
        zip.file(`${safeTitle()}-${String(i+1).padStart(2,"0")}-${L}.png`, letterBlob);
      }

      const blob = await zip.generateAsync({type:"blob", compression:"DEFLATE", compressionOptions:{level:6}});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${safeTitle()}-Cover+26Letters.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("ZIP 导出完成：封面 + 26 字母。");
    }catch(err){
      console.error(err);
      showToast("ZIP 导出失败，请重试。");
    }
  }

  // ---------- DOM export overrides (match preview) ----------
  function waitNextFrame(){
    return new Promise((resolve)=> requestAnimationFrame(()=> requestAnimationFrame(resolve)));
  }

  async function waitFontsReady(){
    if(document.fonts && document.fonts.ready){
      try { await document.fonts.ready; } catch(_) {}
    }
  }

  function syncPreviewAspect(spec = getExportSpec()){
    if(!previewScope) return;
    previewScope.style.setProperty("--export-aspect-cover", `${spec.W} / ${spec.H}`);
    previewScope.style.setProperty("--export-aspect-letter", `${spec.W} / ${spec.H}`);
  }

  async function captureFrameCanvas(frameEl, spec){
    if(typeof html2canvas === "undefined"){
      throw new Error("html2canvas not loaded");
    }
    syncPreviewAspect(spec);
    await waitFontsReady();
    await waitNextFrame();

    const rect = frameEl.getBoundingClientRect();
    const width = Math.max(1, rect.width);
    const scale = Math.max(1, spec.W / width);
    const src = await html2canvas(frameEl, {
      backgroundColor: null,
      useCORS: true,
      scale
    });
    if(src.width === spec.W && src.height === spec.H){
      return src;
    }
    const out = document.createElement("canvas");
    out.width = spec.W;
    out.height = spec.H;
    const octx = out.getContext("2d");
    octx.drawImage(src, 0, 0, out.width, out.height);
    return out;
  }

  function switchCurrentLetter(letter){
    state.current = letter;
    loadCurrentEdits();
    renderAZ();
    renderPreview();
  }

  async function exportCoverPNG(){
    saveCurrentEdits();
    if(!coverFrame){
      showToast("封面预览节点不存在。");
      return;
    }
    try{
      const spec = getExportSpec();
      const canvas = await captureFrameCanvas(coverFrame, spec);
      downloadCanvas(canvas, `${safeTitle()}-00-Cover.png`);
      showToast("已开始下载封面 PNG。");
    }catch(err){
      console.error(err);
      showToast("导出封面失败。");
    }
  }

  async function exportLetterPNG(letter){
    saveCurrentEdits();
    if(!letterFrame){
      showToast("字母卡片预览节点不存在。");
      return;
    }
    const prev = state.current;
    try{
      if(letter !== prev){
        switchCurrentLetter(letter);
      }
      const spec = getExportSpec();
      const canvas = await captureFrameCanvas(letterFrame, spec);
      downloadCanvas(canvas, `${safeTitle()}-${letter}.png`);
    }catch(err){
      console.error(err);
      showToast("导出字母卡片失败。");
    }finally{
      if(prev !== state.current){
        switchCurrentLetter(prev);
      }
    }
  }

  async function exportZip(){
    saveCurrentEdits();
    if(typeof JSZip === "undefined"){
      showToast("JSZip 未加载，无法导出 ZIP。");
      return;
    }
    if(typeof html2canvas === "undefined"){
      showToast("html2canvas 未加载，无法导出 ZIP。");
      return;
    }
    if(!coverFrame || !letterFrame){
      showToast("导出节点缺失。");
      return;
    }

    const spec = getExportSpec();
    const zip = new JSZip();
    const prev = state.current;
    showToast("正在按预览样式打包封面+26字母，请稍候...");
    try{
      const coverCanvas = await captureFrameCanvas(coverFrame, spec);
      zip.file(`${safeTitle()}-00-Cover.png`, await canvasToBlob(coverCanvas));

      for(let i=0;i<letters.length;i++){
        const L = letters[i];
        switchCurrentLetter(L);
        const letterCanvas = await captureFrameCanvas(letterFrame, spec);
        zip.file(`${safeTitle()}-${String(i+1).padStart(2,"0")}-${L}.png`, await canvasToBlob(letterCanvas));
      }

      const blob = await zip.generateAsync({type:"blob", compression:"DEFLATE", compressionOptions:{level:6}});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${safeTitle()}-Cover+26Letters.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("ZIP 导出完成（与预览一致）。");
    }catch(err){
      console.error(err);
      showToast("ZIP 导出失败，请重试。");
    }finally{
      switchCurrentLetter(prev);
    }
  }

  async function exportLongPNG(){
    saveCurrentEdits();
    if(typeof html2canvas === "undefined"){
      showToast("html2canvas 未加载，无法导出长图。");
      return;
    }
    if(!letterFrame){
      showToast("字母卡片预览节点不存在。");
      return;
    }

    const spec = getExportSpec();
    const prev = state.current;
    try{
      const cards = [];
      for(let i=0;i<letters.length;i++){
        switchCurrentLetter(letters[i]);
        cards.push(await captureFrameCanvas(letterFrame, spec));
      }

      const MAX_CANVAS_H = 30000;
      const rawH = spec.H * cards.length;
      const ratio = rawH > MAX_CANVAS_H ? (MAX_CANVAS_H / rawH) : 1;
      const outW = Math.max(1, Math.round(spec.W * ratio));
      const slotH = Math.max(1, Math.round(spec.H * ratio));
      const outH = slotH * cards.length;

      const out = document.createElement("canvas");
      out.width = outW;
      out.height = outH;
      const octx = out.getContext("2d");

      cards.forEach((c, i)=>{
        octx.drawImage(c, 0, i * slotH, outW, slotH);
      });
      downloadCanvas(out, `${safeTitle()}-LongBody.png`);
      showToast("已开始下载正文长图 PNG（与预览样式一致）。");
    }catch(err){
      console.error(err);
      showToast("导出长图失败，请重试。");
    }finally{
      switchCurrentLetter(prev);
    }
  }

  // ---------- Local save/load ----------
  const STORAGE_KEY = "az_writer_demo_v3_unified_theme";
  function saveLocal(){
    saveCurrentEdits();
    const payload = {
      projectTitle: $("projectTitle").value,
      projectAuthor: $("projectAuthor").value,
      projectSubtitle: projectSubtitleInput.value,
      projectWatermark: projectWatermarkInput.value,
      style: state.style,
      theme: state.theme,
      vars: state.vars,
      coverBgImageData: state.coverBgImageData,
      coverBgImageEnabled: state.coverBgImageEnabled,
      letterBgImageData: state.letterBgImageData,
      letterBgImageEnabled: state.letterBgImageEnabled,
      coverImageData: state.coverImageData,
      coverImageEnabled: state.coverImageEnabled,
      items: state.items,
      current: state.current
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    showToast("已保存到本地（localStorage）。");
  }
  function loadLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ showToast("本地没有存档。"); return; }
    try{
      const p = JSON.parse(raw);
      state.style = p.style || state.style;
      state.theme = THEME_IDS.includes(p.theme) ? p.theme : state.theme;
      state.vars = p.vars || readThemeVarsFromCss(state.theme);
      state.coverBgImageEnabled = typeof p.coverBgImageEnabled === "boolean"
        ? p.coverBgImageEnabled
        : (typeof p.bgImageEnabled === "boolean" ? p.bgImageEnabled : true);
      state.letterBgImageEnabled = typeof p.letterBgImageEnabled === "boolean"
        ? p.letterBgImageEnabled
        : (typeof p.bgImageEnabled === "boolean" ? p.bgImageEnabled : true);
      state.coverImageEnabled = typeof p.coverImageEnabled === "boolean" ? p.coverImageEnabled : true;
      state.items = p.items || state.items;
      state.current = p.current || "A";
      state.projectSubtitle = typeof p.projectSubtitle === "string"
        ? p.projectSubtitle
        : (typeof p.cardMetaTitle === "string" ? p.cardMetaTitle : state.projectSubtitle);
      state.projectWatermark = typeof p.projectWatermark === "string"
        ? p.projectWatermark
        : (typeof p.cardWatermark === "string" ? p.cardWatermark : state.projectWatermark);

      $("styleSelect").value = state.style;
      $("themeSelect").value = state.theme;
      $("projectTitle").value = p.projectTitle || "";
      $("projectAuthor").value = p.projectAuthor || "";
      projectSubtitleInput.value = state.projectSubtitle;
      projectWatermarkInput.value = state.projectWatermark;
      coverBgImageEnabled.checked = state.coverBgImageEnabled;
      letterBgImageEnabled.checked = state.letterBgImageEnabled;
      coverImageEnabled.checked = state.coverImageEnabled;
      setFrameBackgroundImageData("cover", p.coverBgImageData || p.bgImageData || "");
      setFrameBackgroundImageData("letter", p.letterBgImageData || p.bgImageData || "");
      setCoverImageData(p.coverImageData || "");

      clearCustomStyleVars();
      setCSSVars(state.vars);
      radius.value = parseInt(state.vars["--radius"],10) || 18;
      radiusLabel.textContent = `${radius.value}px`;
      syncFineTuneControls(false);

      renderAZ();
      loadCurrentEdits();
      renderPreview();
      showToast("已从本地载入。");
    }catch(e){
      console.error(e);
      showToast("载入失败：存档损坏。");
    }
  }

  // ---------- Events ----------
  $("styleSelect").addEventListener("change", (e)=>{
    saveCurrentEdits();
    state.style = e.target.value;
    ensureDefaultsIfEmpty();
    renderPreview();
    showToast("已切换风格。你可以重新随机生成未锁定项。");
  });

  $("themeSelect").addEventListener("change", (e)=>{
    applyTheme(e.target.value);
    renderPreview();
  });

  $("sizePreset").addEventListener("change", ()=>{
    syncPreviewAspect();
    renderPreview();
  });

  coverBgImageInput.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    state.coverBgImageEnabled = true;
    coverBgImageEnabled.checked = true;
    setFrameBackgroundImageFile("cover", file);
    applyPreviewBackground();
    showToast("封面背景图已更新。");
    coverBgImageInput.value = "";
  });

  coverBgImageEnabled.addEventListener("change", ()=>{
    state.coverBgImageEnabled = coverBgImageEnabled.checked;
    applyPreviewBackground();
  });

  clearCoverBgImageBtn.addEventListener("click", ()=>{
    setFrameBackgroundImageData("cover", "");
    state.coverBgImageEnabled = false;
    coverBgImageEnabled.checked = false;
    showToast("已清除封面背景图。");
  });

  letterBgImageInput.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    state.letterBgImageEnabled = true;
    letterBgImageEnabled.checked = true;
    setFrameBackgroundImageFile("letter", file);
    applyPreviewBackground();
    showToast("卡片页背景图已更新。");
    letterBgImageInput.value = "";
  });

  letterBgImageEnabled.addEventListener("change", ()=>{
    state.letterBgImageEnabled = letterBgImageEnabled.checked;
    applyPreviewBackground();
  });

  clearLetterBgImageBtn.addEventListener("click", ()=>{
    setFrameBackgroundImageData("letter", "");
    state.letterBgImageEnabled = false;
    letterBgImageEnabled.checked = false;
    showToast("已清除卡片页背景图。");
  });

  coverImageInput.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      setCoverImageData(String(reader.result || ""));
      state.coverImageEnabled = true;
      coverImageEnabled.checked = true;
      showToast("封面头图已更新。");
    };
    reader.readAsDataURL(file);
    coverImageInput.value = "";
  });

  coverImageEnabled.addEventListener("change", ()=>{
    state.coverImageEnabled = coverImageEnabled.checked;
    applyCoverImage();
  });

  clearCoverImageBtn.addEventListener("click", ()=>{
    setCoverImageData("");
    state.coverImageEnabled = false;
    coverImageEnabled.checked = false;
    showToast("已清除封面头图。");
  });

  $("projectTitle").addEventListener("input", renderPreview);
  $("projectAuthor").addEventListener("input", renderPreview);
  projectSubtitleInput.addEventListener("input", ()=>{
    state.projectSubtitle = projectSubtitleInput.value.trim() || "A–Z 短篇合集";
    renderPreview();
  });
  projectWatermarkInput.addEventListener("input", ()=>{
    state.projectWatermark = projectWatermarkInput.value.trim() || "{letter} / Z";
    renderPreview();
  });

  wordEn.addEventListener("input", ()=>{ saveCurrentEdits(); renderPreview(); });
  wordZh.addEventListener("input", ()=>{ saveCurrentEdits(); renderPreview(); });

  entryText.addEventListener("input", ()=>{
    saveCurrentEdits();
    $("countInfo").textContent = `字数：${(entryText.value||"").replace(/\s/g,"").length}`;
    renderPreview();
  });

  $("genBtn").addEventListener("click", ()=>{ saveCurrentEdits(); generateAZ(); });
  $("fillDemoBtn").addEventListener("click", ()=>{ saveCurrentEdits(); fillDemoText(); });
  $("clearAllBtn").addEventListener("click", clearAllText);

  $("toggleLockBtn").addEventListener("click", toggleLockCurrent);
  $("lockAllBtn").addEventListener("click", ()=>lockAll(true));
  $("unlockAllBtn").addEventListener("click", ()=>lockAll(false));

  $("prevBtn").addEventListener("click", ()=>{
    saveCurrentEdits();
    let idx = letters.indexOf(state.current);
    idx = (idx - 1 + 26) % 26;
    state.current = letters[idx];
    loadCurrentEdits();
    renderAZ();
    renderPreview();
  });

  $("nextBtn").addEventListener("click", ()=>{
    saveCurrentEdits();
    let idx = letters.indexOf(state.current);
    idx = (idx + 1) % 26;
    state.current = letters[idx];
    loadCurrentEdits();
    renderAZ();
    renderPreview();
  });

  coverBgColor.addEventListener("input", ()=> setVar("--custom-cover-bg-color", coverBgColor.value));
  letterBgColor.addEventListener("input", ()=> setVar("--custom-letter-bg-color", letterBgColor.value));
  transColorFine.addEventListener("input", ()=> setVar("--custom-trans-color", transColorFine.value));
  bodySize.addEventListener("input", ()=>{
    bodySizeLabel.textContent = `${bodySize.value}px`;
    setVar("--custom-trans-size", `${bodySize.value}px`);
  });
  radius.addEventListener("input", ()=>{
    radiusLabel.textContent = `${radius.value}px`;
    setVar("--radius", `${radius.value}px`);
  });

  coverTitleColor.addEventListener("input", ()=> setVar("--custom-cover-title-color", coverTitleColor.value));
  coverBadgeColor.addEventListener("input", ()=> setVar("--custom-cover-badge-color", coverBadgeColor.value));
  coverAuthorColor.addEventListener("input", ()=> setVar("--custom-cover-author-color", coverAuthorColor.value));
  metaColor.addEventListener("input", ()=> setVar("--custom-meta-color", metaColor.value));
  decoColor.addEventListener("input", ()=> setVar("--custom-deco-color", decoColor.value));
  letterColor.addEventListener("input", ()=> setVar("--custom-letter-color", letterColor.value));
  wordColorFine.addEventListener("input", ()=> setVar("--custom-word-color", wordColorFine.value));
  bodyColorFine.addEventListener("input", ()=> setVar("--custom-body-color", bodyColorFine.value));

  coverTitleSize.addEventListener("input", ()=>{
    coverTitleSizeLabel.textContent = `${coverTitleSize.value}px`;
    setVar("--custom-cover-title-size", `${coverTitleSize.value}px`);
  });
  coverBadgeSize.addEventListener("input", ()=>{
    coverBadgeSizeLabel.textContent = `${coverBadgeSize.value}px`;
    setVar("--custom-cover-badge-size", `${coverBadgeSize.value}px`);
  });
  coverAuthorSize.addEventListener("input", ()=>{
    coverAuthorSizeLabel.textContent = `${coverAuthorSize.value}px`;
    setVar("--custom-cover-author-size", `${coverAuthorSize.value}px`);
  });
  metaSize.addEventListener("input", ()=>{
    metaSizeLabel.textContent = `${metaSize.value}px`;
    setVar("--custom-meta-size", `${metaSize.value}px`);
  });
  letterSize.addEventListener("input", ()=>{
    letterSizeLabel.textContent = `${letterSize.value}px`;
    setVar("--custom-letter-size", `${letterSize.value}px`);
  });
  wordSizeFine.addEventListener("input", ()=>{
    wordSizeFineLabel.textContent = `${wordSizeFine.value}px`;
    setVar("--custom-word-size", `${wordSizeFine.value}px`);
  });
  bodySizeFine.addEventListener("input", ()=>{
    bodySizeFineLabel.textContent = `${bodySizeFine.value}px`;
    setVar("--custom-body-size", `${bodySizeFine.value}px`);
  });
  coverImageOpacity.addEventListener("input", ()=>{
    coverImageOpacityLabel.textContent = `${coverImageOpacity.value}%`;
    setVar("--custom-cover-image-opacity", `${(Number(coverImageOpacity.value) || 0) / 100}`);
  });
  const syncCardBoxFill = ()=>{
    const alpha = (Number(cardBoxOpacity.value) || 0) / 100;
    cardBoxOpacityLabel.textContent = `${cardBoxOpacity.value}%`;
    setVar("--custom-card-box-color", cardBoxColor.value);
    setVar("--custom-card-box-opacity", `${alpha}`);
    setVar("--custom-card-box-bg", rgba(cardBoxColor.value, alpha));
  };
  cardBoxColor.addEventListener("input", syncCardBoxFill);
  cardBoxOpacity.addEventListener("input", syncCardBoxFill);

  $("resetVarsBtn").addEventListener("click", ()=> applyTheme(state.theme));
  $("saveLocalBtn").addEventListener("click", saveLocal);
  $("loadLocalBtn").addEventListener("click", loadLocal);

  $("exportCoverBtn").addEventListener("click", exportCoverPNG);
  $("exportOneBtn").addEventListener("click", ()=>{
    exportLetterPNG(state.current);
  });
  $("exportZipBtn").addEventListener("click", exportZip);
  $("exportLongBtn").addEventListener("click", exportLongPNG);

  window.addEventListener("beforeunload", ()=>{
    revokeObjectUrl("coverBgImageObjectUrl");
    revokeObjectUrl("letterBgImageObjectUrl");
  });

  // ---------- Init ----------
  initItems();
  mountThemeVarsPanel();
  applyTheme(state.theme);
  projectSubtitleInput.value = state.projectSubtitle;
  projectWatermarkInput.value = state.projectWatermark;

  // Seed A
  const wA = pickWord(state.style, "A");
  state.items["A"].en = wA.en;
  state.items["A"].zh = wA.zh;

  renderAZ();
  loadCurrentEdits();
  renderPreview();
})();
</script>
</body>
</html>
